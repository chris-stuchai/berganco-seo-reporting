<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Portal - BerganCo SEO</title>
  <link rel="icon" type="image/png" href="https://framerusercontent.com/images/AhyGPdkv1Kr9JeLtiQvJBU0uJE.png?scale-down-to=1024&width=2088&height=518">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Apple Design System - Dark Mode */
    :root {
      --color-bg-primary: #1C1C1E;
      --color-bg-secondary: #2C2C2E;
      --color-bg-tertiary: #3A3A3C;
      --color-label-primary: #FFFFFF;
      --color-label-secondary: #E5E5EA;
      --color-label-tertiary: #98989D;
      --color-separator: #48484A;
      --color-blue: #0A84FF;
      --color-green: #30D158;
      --color-red: #FF453A;
      --spacing-2: 8px;
      --spacing-4: 16px;
      --spacing-6: 24px;
      --font-body: 17px;
      --font-footnote: 13px;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; background: var(--color-bg-primary); color: var(--color-label-primary); margin: 0; }
    .container { max-width: 1400px; margin: 0 auto; padding: var(--spacing-6); }
    .card { 
      background: var(--color-bg-secondary); 
      border: 0.5px solid var(--color-separator); 
      border-radius: 12px; 
      padding: var(--spacing-6); 
      margin-bottom: var(--spacing-6); 
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }
    /* Buttons - StuchAI Guidelines */
    .btn { 
      padding: var(--spacing-2) var(--spacing-4); 
      border-radius: 12px; 
      border: none; 
      cursor: pointer; 
      font-size: var(--font-body); 
      font-weight: 500;
      transition: opacity 0.2s; 
    }
    .btn-primary { 
      background: var(--color-blue); 
      color: white; 
    }
    .btn-primary:hover:not(:disabled) {
      opacity: 0.85;
    }
    .btn-danger { 
      background: var(--color-red); 
      color: white; 
    }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: var(--spacing-3); text-align: left; border-bottom: 1px solid var(--color-separator); }
    .table th { color: var(--color-label-tertiary); font-size: var(--font-footnote); font-weight: 600; text-transform: uppercase; }
    /* Form Input Styling - StuchAI Guidelines */
    .form-group {
      margin-bottom: var(--spacing-4);
    }
    
    .form-label {
      display: block;
      font-size: var(--font-footnote);
      font-weight: 500;
      color: var(--color-label-secondary);
      margin-bottom: var(--spacing-2);
    }
    
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="date"],
    input[type="week"],
    select,
    textarea {
      width: 100%;
      padding: var(--spacing-3) var(--spacing-4);
      background: var(--color-bg-tertiary);
      border: 0.5px solid var(--color-separator);
      border-radius: 12px;
      color: var(--color-label-primary);
      font-size: var(--font-body);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      box-sizing: border-box;
    }
    
    textarea {
      resize: vertical;
      min-height: 100px;
      line-height: 1.47;
    }
    
    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus,
    input[type="date"]:focus,
    input[type="week"]:focus,
    select:focus,
    textarea:focus {
      border-color: var(--color-blue);
      box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.15);
    }
    
    input::placeholder,
    textarea::placeholder {
      color: var(--color-label-tertiary);
    }
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .badge-admin { background: rgba(255, 69, 58, 0.2); color: var(--color-red); }
    .badge-employee { background: rgba(10, 132, 255, 0.2); color: var(--color-blue); }
    .badge-client { background: rgba(48, 209, 88, 0.2); color: var(--color-green); }
    
    /* Loading spinner */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-6);
    }
    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--color-separator);
      border-top-color: var(--color-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-6);">
      <h1 style="font-size: 34px; font-weight: 700; margin: 0;">Employee Portal</h1>
      <button class="btn btn-secondary" onclick="handleLogout()" style="display: flex; align-items: center; gap: var(--spacing-2);">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
        </svg>
        Sign Out
      </button>
    </div>

    <!-- User Management -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-4);">
        <h2 style="font-size: 22px; font-weight: 600;">User Management</h2>
        <button class="btn btn-primary" onclick="showCreateUserModal()">+ Create User</button>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTable">
          <tr><td colspan="6" style="text-align: center; padding: var(--spacing-6); color: var(--color-label-tertiary);">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Weekly Tasks for Clients -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-4);">
        <h2 style="font-size: 22px; font-weight: 600;">Weekly Tasks</h2>
        <button class="btn btn-primary" onclick="showCreateTaskModal()">+ Create Task</button>
      </div>
      
      <!-- Week Filter -->
      <div style="margin-bottom: var(--spacing-4); display: flex; gap: var(--spacing-2); align-items: center;">
        <label style="font-size: var(--font-footnote); color: var(--color-label-secondary);">Week:</label>
        <input type="week" id="taskWeekFilter" onchange="loadTasks()" style="padding: var(--spacing-2) var(--spacing-3); background: var(--color-bg-tertiary); border: 1px solid var(--color-separator); border-radius: 8px; color: var(--color-label-primary); font-size: var(--font-footnote);">
      </div>
      
      <div id="tasksList" style="display: grid; gap: var(--spacing-3);">
        <div style="text-align: center; padding: var(--spacing-6); color: var(--color-label-tertiary);">Loading tasks...</div>
      </div>
    </div>

    <!-- System Controls -->
    <div class="card">
      <h2 style="font-size: 22px; font-weight: 600; margin-bottom: var(--spacing-4);">System Controls</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-4); margin-bottom: var(--spacing-6);">
        <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-radius: 8px;">
          <h3 style="font-size: var(--font-body); font-weight: 600; margin-bottom: var(--spacing-2);">Collect Data</h3>
          <p style="font-size: var(--font-footnote); color: var(--color-label-tertiary); margin-bottom: var(--spacing-3);">Collect today's metrics</p>
          <button class="btn btn-primary" onclick="collectData()" style="width: 100%;">Collect Now</button>
        </div>
        <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-radius: 8px;">
          <h3 style="font-size: var(--font-body); font-weight: 600; margin-bottom: var(--spacing-2);">Generate Report</h3>
          <p style="font-size: var(--font-footnote); color: var(--color-label-tertiary); margin-bottom: var(--spacing-3);">Generate SEO report</p>
          
          <!-- Timeframe Selection -->
          <div style="margin-bottom: var(--spacing-3);">
            <label style="font-size: var(--font-footnote); color: var(--color-label-secondary); display: block; margin-bottom: var(--spacing-1);">Report Period</label>
            <select id="reportPeriodType" style="width: 100%; padding: var(--spacing-2); background: var(--color-bg-secondary); border: 1px solid var(--color-separator); border-radius: 8px; color: var(--color-label-primary); font-size: var(--font-footnote); margin-bottom: var(--spacing-2);">
              <option value="week">Last Week</option>
              <option value="month">Last 30 Days</option>
              <option value="custom">Custom Range</option>
            </select>
            
            <!-- Custom Date Range (hidden by default) -->
            <div id="customDateRange" style="display: none; margin-top: var(--spacing-2);">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-2);">
                <div>
                  <label style="font-size: var(--font-caption); color: var(--color-label-tertiary); display: block; margin-bottom: var(--spacing-1);">Start Date</label>
                  <input type="date" id="reportStartDate" style="width: 100%; padding: var(--spacing-2); background: var(--color-bg-secondary); border: 1px solid var(--color-separator); border-radius: 8px; color: var(--color-label-primary); font-size: var(--font-footnote);">
                </div>
                <div>
                  <label style="font-size: var(--font-caption); color: var(--color-label-tertiary); display: block; margin-bottom: var(--spacing-1);">End Date</label>
                  <input type="date" id="reportEndDate" style="width: 100%; padding: var(--spacing-2); background: var(--color-bg-secondary); border: 1px solid var(--color-separator); border-radius: 8px; color: var(--color-label-primary); font-size: var(--font-footnote);">
                </div>
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: var(--spacing-2);">
            <button class="btn btn-secondary" onclick="previewReport()" style="flex: 1;">Preview Email</button>
            <button class="btn btn-primary" onclick="generateReport()" style="flex: 1;">Generate Now</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Schedule Configuration -->
    <div class="card">
      <h2 style="font-size: 22px; font-weight: 600; margin-bottom: var(--spacing-4);">Schedule Configuration</h2>
      <p style="font-size: var(--font-footnote); color: var(--color-label-tertiary); margin-bottom: var(--spacing-4);">Configure automated schedules using cron expressions (e.g., "0 3 * * *" = daily at 3 AM)</p>
      <div id="scheduleConfig">
        <div class="loading">
          <div class="spinner"></div>
        </div>
      </div>
    </div>

    <!-- Usage Statistics -->
    <div class="card">
      <h2 style="font-size: 22px; font-weight: 600; margin-bottom: var(--spacing-4);">Usage Statistics</h2>
      <p style="font-size: var(--font-footnote); color: var(--color-label-tertiary); margin-bottom: var(--spacing-4);">Track API usage and costs</p>
      <div id="usageStats">
        <div class="loading">
          <div class="spinner"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Email Preview Modal -->
  <div id="emailPreviewModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: var(--spacing-4);">
    <div style="background: var(--color-bg-secondary); border: 0.5px solid var(--color-separator); border-radius: 16px; padding: var(--spacing-4); width: 100%; max-width: 900px; max-height: 90vh; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4); display: flex; flex-direction: column;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-4);">
        <h2 style="font-size: 28px; font-weight: 700; color: var(--color-label-primary);">Email Preview</h2>
        <button onclick="closePreviewModal()" style="background: none; border: none; color: var(--color-label-secondary); cursor: pointer; font-size: 24px; padding: var(--spacing-2);">&times;</button>
      </div>
      <div style="flex: 1; overflow: auto; border: 1px solid var(--color-separator); border-radius: 8px; background: white;">
        <iframe id="emailPreviewFrame" style="width: 100%; height: 70vh; border: none;"></iframe>
      </div>
      <div style="margin-top: var(--spacing-4); display: flex; justify-content: flex-end; gap: var(--spacing-2);">
        <button class="btn btn-secondary" onclick="closePreviewModal()">Close</button>
        <button class="btn btn-primary" onclick="sendReportFromPreview()">Send Email</button>
      </div>
    </div>
  </div>

  <!-- Create User Modal -->
  <div id="createUserModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: var(--spacing-4);">
    <div style="background: var(--color-bg-secondary); border: 0.5px solid var(--color-separator); border-radius: 16px; padding: var(--spacing-6); width: 100%; max-width: 500px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);">
      <h2 style="font-size: 28px; font-weight: 700; color: var(--color-label-primary); margin-bottom: var(--spacing-6);">Create User</h2>
      
      <form onsubmit="event.preventDefault(); createUser();">
        <div class="form-group">
          <label class="form-label" for="createName">Name</label>
          <input type="text" id="createName" placeholder="Full Name" required>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="createEmail">Email</label>
          <input type="email" id="createEmail" placeholder="user@example.com" required>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="createPassword">Password</label>
          <div style="display: flex; gap: var(--spacing-2); align-items: center;">
            <input type="password" id="createPassword" placeholder="Enter a secure password" required style="flex: 1;">
            <button type="button" onclick="generatePassword('createPassword')" class="btn" style="padding: var(--spacing-2) var(--spacing-3); background: var(--color-bg-tertiary); border: 0.5px solid var(--color-separator); color: var(--color-label-primary); white-space: nowrap; font-size: var(--font-footnote);">Generate</button>
          </div>
        </div>
        
        <div class="form-group" style="margin-bottom: var(--spacing-6);">
          <label class="form-label" for="createRole">Role</label>
          <select id="createRole" required>
            <option value="CLIENT">Client</option>
            <option value="EMPLOYEE">Employee</option>
            <option value="ADMIN">Admin</option>
          </select>
        </div>
        
        <div style="display: flex; gap: var(--spacing-3);">
          <button type="submit" class="btn btn-primary" style="flex: 1; padding: var(--spacing-3) var(--spacing-4); border-radius: 12px; font-weight: 500;">Create</button>
          <button type="button" onclick="closeCreateUserModal()" class="btn" style="flex: 1; padding: var(--spacing-3) var(--spacing-4); border-radius: 12px; background: var(--color-bg-tertiary); border: 0.5px solid var(--color-separator); color: var(--color-label-primary);">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div id="editUserModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: var(--spacing-4);">
    <div style="background: var(--color-bg-secondary); border: 0.5px solid var(--color-separator); border-radius: 16px; padding: var(--spacing-6); width: 100%; max-width: 500px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);">
      <h2 style="font-size: 28px; font-weight: 700; color: var(--color-label-primary); margin-bottom: var(--spacing-6);">Edit User</h2>
      
      <form onsubmit="event.preventDefault(); updateUser();">
        <input type="hidden" id="editUserId">
        
        <div class="form-group">
          <label class="form-label" for="editName">Name</label>
          <input type="text" id="editName" placeholder="Full Name" required>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="editEmail">Email</label>
          <input type="email" id="editEmail" placeholder="user@example.com" required>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="editPassword">Password (leave blank to keep current)</label>
          <div style="display: flex; gap: var(--spacing-2); align-items: center;">
            <input type="password" id="editPassword" placeholder="Enter new password (optional)" style="flex: 1;">
            <button type="button" onclick="generatePassword('editPassword')" class="btn" style="padding: var(--spacing-2) var(--spacing-3); background: var(--color-bg-tertiary); border: 0.5px solid var(--color-separator); color: var(--color-label-primary); white-space: nowrap; font-size: var(--font-footnote);">Generate</button>
          </div>
        </div>
        
        <div class="form-group" style="margin-bottom: var(--spacing-6);">
          <label class="form-label" for="editRole">Role</label>
          <select id="editRole" required>
            <option value="CLIENT">Client</option>
            <option value="EMPLOYEE">Employee</option>
            <option value="ADMIN">Admin</option>
          </select>
        </div>
        
        <div style="display: flex; gap: var(--spacing-3);">
          <button type="submit" class="btn btn-primary" style="flex: 1; padding: var(--spacing-3) var(--spacing-4); border-radius: 12px; font-weight: 500;">Update</button>
          <button type="button" onclick="closeEditUserModal()" class="btn" style="flex: 1; padding: var(--spacing-3) var(--spacing-4); border-radius: 12px; background: var(--color-bg-tertiary); border: 0.5px solid var(--color-separator); color: var(--color-label-primary);">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create/Edit Task Modal -->
  <div id="taskModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: var(--spacing-4);">
    <div style="background: var(--color-bg-secondary); border: 0.5px solid var(--color-separator); border-radius: 16px; padding: var(--spacing-6); width: 100%; max-width: 600px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4); max-height: 90vh; overflow-y: auto;">
      <h2 id="taskModalTitle" style="font-size: 28px; font-weight: 700; color: var(--color-label-primary); margin-bottom: var(--spacing-6);">Create Task</h2>
      
      <form onsubmit="event.preventDefault(); saveTask();">
        <input type="hidden" id="taskId">
        
        <div class="form-group">
          <label class="form-label" for="taskClient">Client</label>
          <select id="taskClient" required>
            <option value="">Select a client...</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="taskTitle">Task Title</label>
          <input type="text" id="taskTitle" placeholder="e.g., Optimize meta descriptions for top pages" required>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="taskDescription">Description</label>
          <textarea id="taskDescription" rows="4" placeholder="Describe what needs to be done..." required></textarea>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
          <div class="form-group">
            <label class="form-label" for="taskPriority">Priority</label>
            <select id="taskPriority" required>
              <option value="LOW">Low</option>
              <option value="MEDIUM" selected>Medium</option>
              <option value="HIGH">High</option>
              <option value="URGENT">Urgent</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="taskDueDate">Due Date</label>
            <input type="date" id="taskDueDate" required>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
          <div class="form-group">
            <label class="form-label" for="taskWeekStart">Week Start Date</label>
            <input type="date" id="taskWeekStart" required>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="taskWeekEnd">Week End Date</label>
            <input type="date" id="taskWeekEnd" required>
          </div>
        </div>
        
        <div style="display: flex; gap: var(--spacing-3); margin-top: var(--spacing-6);">
          <button type="submit" class="btn btn-primary" style="flex: 1; padding: var(--spacing-3) var(--spacing-4); border-radius: 12px; font-weight: 500;">Save Task</button>
          <button type="button" onclick="closeTaskModal()" class="btn" style="flex: 1; padding: var(--spacing-3) var(--spacing-4); border-radius: 12px; background: var(--color-bg-tertiary); border: 0.5px solid var(--color-separator); color: var(--color-label-primary);">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Check auth - don't redirect away if user is admin/employee
    (async function() {
      try {
        const res = await fetch('/api/auth/me', { credentials: 'include' });
        if (!res.ok) {
          console.log('Auth check failed, redirecting to login');
          window.location.replace('/login');
          return;
        }
        const data = await res.json();
        const userRole = data.user?.role;
        console.log('Employee portal auth check, user role:', userRole);
        
        // Only redirect if user is not admin or employee
        if (!userRole || (userRole !== 'ADMIN' && userRole !== 'EMPLOYEE')) {
          console.warn('User is not admin/employee, redirecting to login. Role:', userRole);
          window.location.replace('/login');
          return;
        }
        
        // User is admin/employee - stay on this page
        console.log('Admin/Employee authenticated, loading employee portal');
        loadUsers();
        loadTasks();
        loadUsageStats();
        loadSchedules();
        
        // Set default week to current week
        const today = new Date();
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay() + 1); // Monday
        const year = startOfWeek.getFullYear();
        const weekNum = getWeekNumber(startOfWeek);
        document.getElementById('taskWeekFilter').value = `${year}-W${weekNum.toString().padStart(2, '0')}`;
        
        // Helper function to get week number
        function getWeekNumber(date) {
          const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
          const dayNum = d.getUTCDay() || 7;
          d.setUTCDate(d.getUTCDate() + 4 - dayNum);
          const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
          return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.replace('/login');
      }
    })();

    async function loadUsers() {
      try {
        const res = await fetch('/api/users', { credentials: 'include' });
        if (!res.ok) {
          const error = await res.json();
          document.getElementById('usersTable').innerHTML = `
            <tr><td colspan="6" style="text-align: center; padding: var(--spacing-6); color: var(--color-red);">
              Error loading users: ${error.error || 'Unknown error'}
            </td></tr>
          `;
          return;
        }
        const users = await res.json();
        const tbody = document.getElementById('usersTable');
        
        if (!users || users.length === 0) {
          tbody.innerHTML = `
            <tr><td colspan="6" style="text-align: center; padding: var(--spacing-6); color: var(--color-label-tertiary);">
              No users found. Create your first user above.
            </td></tr>
          `;
          return;
        }
        
        tbody.innerHTML = users.map(u => `
          <tr>
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td><span class="badge badge-${u.role.toLowerCase()}">${u.role}</span></td>
            <td>${u.isActive ? 'Active' : 'Inactive'}</td>
            <td>${new Date(u.createdAt).toLocaleDateString()}</td>
            <td>
              <button class="btn" onclick="editUser('${u.id}')" style="padding: 4px 8px; font-size: var(--font-footnote); margin-right: 4px;">Edit</button>
              ${u.role === 'CLIENT' ? `<button class="btn" onclick="impersonateUser('${u.id}')" style="padding: 4px 8px; font-size: var(--font-footnote); background: var(--color-blue); color: white; margin-right: 4px;">View As</button>` : ''}
              ${u.role !== 'ADMIN' ? `<button class="btn btn-danger" onclick="deleteUser('${u.id}')" style="padding: 4px 8px; font-size: var(--font-footnote);">Delete</button>` : ''}
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTable').innerHTML = `
          <tr><td colspan="6" style="text-align: center; padding: var(--spacing-6); color: var(--color-red);">
            Failed to load users. Please refresh the page.
          </td></tr>
        `;
      }
    }

    function showCreateUserModal() {
      document.getElementById('createUserModal').style.display = 'flex';
    }

    function closeCreateUserModal() {
      document.getElementById('createUserModal').style.display = 'none';
      // Reset form
      document.getElementById('createName').value = '';
      document.getElementById('createEmail').value = '';
      document.getElementById('createPassword').value = '';
      document.getElementById('createRole').value = 'CLIENT';
    }

    // Generate secure random password
    function generatePassword(inputId) {
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
      let password = '';
      for (let i = 0; i < 16; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById(inputId).value = password;
      document.getElementById(inputId).type = 'text'; // Show generated password
      setTimeout(() => {
        document.getElementById(inputId).type = 'password'; // Hide after 3 seconds
      }, 3000);
    }

    async function createUser() {
      const name = document.getElementById('createName').value;
      const email = document.getElementById('createEmail').value;
      const password = document.getElementById('createPassword').value;
      const role = document.getElementById('createRole').value;
      
      if (!password) {
        alert('Please enter or generate a password');
        return;
      }
      
      try {
        const res = await fetch('/api/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            name,
            email,
            password,
            role,
            sendOnboardingEmail: true // Request onboarding email
          })
        });
        
        if (res.ok) {
          const data = await res.json();
          alert(`User created successfully! ${data.emailSent ? 'Onboarding email sent.' : 'Note: Email could not be sent.'}`);
          closeCreateUserModal();
          loadUsers();
        } else {
          const error = await res.json();
          alert(`Error creating user: ${error.error || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error creating user:', error);
        alert('Failed to create user. Please try again.');
      }
    }

    async function editUser(id) {
      try {
        // Fetch user data
        const res = await fetch(`/api/users`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load users');
        
        const users = await res.json();
        const user = users.find(u => u.id === id);
        
        if (!user) {
          alert('User not found');
          return;
        }
        
        // Populate form
        document.getElementById('editUserId').value = user.id;
        document.getElementById('editName').value = user.name || '';
        document.getElementById('editEmail').value = user.email || '';
        document.getElementById('editPassword').value = '';
        document.getElementById('editRole').value = user.role || 'CLIENT';
        
        // Show modal
        document.getElementById('editUserModal').style.display = 'flex';
      } catch (error) {
        console.error('Error loading user:', error);
        alert('Failed to load user data');
      }
    }

    function closeEditUserModal() {
      document.getElementById('editUserModal').style.display = 'none';
      // Reset form
      document.getElementById('editUserId').value = '';
      document.getElementById('editName').value = '';
      document.getElementById('editEmail').value = '';
      document.getElementById('editPassword').value = '';
      document.getElementById('editRole').value = 'CLIENT';
    }

    async function updateUser() {
      const id = document.getElementById('editUserId').value;
      const name = document.getElementById('editName').value;
      const email = document.getElementById('editEmail').value;
      const password = document.getElementById('editPassword').value;
      const role = document.getElementById('editRole').value;
      
      try {
        const body = { name, email, role };
        if (password) {
          body.password = password;
        }
        
        const res = await fetch(`/api/users/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(body)
        });
        
        if (res.ok) {
          alert('User updated successfully!');
          closeEditUserModal();
          loadUsers();
        } else {
          const error = await res.json();
          alert(`Error updating user: ${error.error || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error updating user:', error);
        alert('Failed to update user. Please try again.');
      }
    }

    async function deleteUser(id) {
      if (!confirm('Are you sure?')) return;
      await fetch(`/api/users/${id}`, { method: 'DELETE', credentials: 'include' });
      loadUsers();
    }

    // Task Management Functions
    async function loadTasks() {
      try {
        const weekFilter = document.getElementById('taskWeekFilter').value;
        let url = '/api/tasks';
        
        if (weekFilter) {
          // Convert week format (YYYY-Www) to date range
          const [year, week] = weekFilter.split('-W');
          const weekStart = getDateOfISOWeek(parseInt(year), parseInt(week));
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekEnd.getDate() + 6);
          
          url += `?weekStartDate=${weekStart.toISOString().split('T')[0]}`;
        }
        
        const res = await fetch(url, { credentials: 'include' });
        if (!res.ok) {
          throw new Error('Failed to load tasks');
        }
        
        const tasks = await res.json();
        const tasksList = document.getElementById('tasksList');
        
        if (!tasks || tasks.length === 0) {
          tasksList.innerHTML = '<div style="text-align: center; padding: var(--spacing-6); color: var(--color-label-tertiary);">No tasks for this week. Create one above.</div>';
          return;
        }
        
        tasksList.innerHTML = tasks.map(task => {
          const priorityColors = {
            LOW: '#98989D',
            MEDIUM: '#0A84FF',
            HIGH: '#FF9F0A',
            URGENT: '#FF453A'
          };
          const statusColors = {
            PENDING: '#98989D',
            IN_PROGRESS: '#0A84FF',
            COMPLETED: '#30D158',
            CANCELLED: '#98989D'
          };
          
          const priorityBg = priorityColors[task.priority] || '#98989D';
          const statusBg = statusColors[task.status] || '#98989D';
          
          return `
            <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-radius: 12px; border: 1px solid var(--color-separator);">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-2);">
                <div style="flex: 1;">
                  <h3 style="font-size: var(--font-body); font-weight: 600; margin: 0 0 var(--spacing-1) 0;">${task.title}</h3>
                  <p style="font-size: var(--font-footnote); color: var(--color-label-secondary); margin: 0;">
                    ${task.user.businessName || task.user.name} • Due: ${new Date(task.dueDate).toLocaleDateString()}
                  </p>
                </div>
                <div style="display: flex; gap: var(--spacing-2);">
                  <span style="padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; background: ${priorityBg}20; color: ${priorityBg};">
                    ${task.priority}
                  </span>
                  <span style="padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; background: ${statusBg}20; color: ${statusBg};">
                    ${task.status}
                  </span>
                </div>
              </div>
              <p style="font-size: var(--font-footnote); color: var(--color-label-secondary); margin: 0 0 var(--spacing-3) 0; line-height: 1.5;">
                ${task.description}
              </p>
              <div style="display: flex; gap: var(--spacing-2);">
                <button onclick="editTask('${task.id}')" class="btn" style="padding: 4px 8px; font-size: var(--font-footnote);">Edit</button>
                ${task.status !== 'COMPLETED' ? `<button onclick="updateTaskStatus('${task.id}', 'COMPLETED')" class="btn" style="padding: 4px 8px; font-size: var(--font-footnote); background: var(--color-green); color: white;">Mark Complete</button>` : ''}
                <button onclick="deleteTask('${task.id}')" class="btn btn-danger" style="padding: 4px 8px; font-size: var(--font-footnote);">Delete</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading tasks:', error);
        document.getElementById('tasksList').innerHTML = '<div style="text-align: center; padding: var(--spacing-6); color: var(--color-red);">Failed to load tasks.</div>';
      }
    }

    function getDateOfISOWeek(year, week) {
      const simple = new Date(year, 0, 1 + (week - 1) * 7);
      const dow = simple.getDay();
      const ISOweekStart = simple;
      if (dow <= 4) {
        ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
      } else {
        ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
      }
      return ISOweekStart;
    }

    async function showCreateTaskModal() {
      // Load clients
      const usersRes = await fetch('/api/users', { credentials: 'include' });
      const users = await usersRes.json();
      const clients = users.filter(u => u.role === 'CLIENT');
      
      const clientSelect = document.getElementById('taskClient');
      clientSelect.innerHTML = '<option value="">Select a client...</option>' + 
        clients.map(c => `<option value="${c.id}">${c.businessName || c.name}</option>`).join('');
      
      // Set default dates to current week
      const today = new Date();
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - today.getDay() + 1); // Monday
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(endOfWeek.getDate() + 6); // Sunday
      
      document.getElementById('taskWeekStart').value = startOfWeek.toISOString().split('T')[0];
      document.getElementById('taskWeekEnd').value = endOfWeek.toISOString().split('T')[0];
      document.getElementById('taskDueDate').value = endOfWeek.toISOString().split('T')[0];
      
      document.getElementById('taskModalTitle').textContent = 'Create Task';
      document.getElementById('taskId').value = '';
      document.getElementById('taskTitle').value = '';
      document.getElementById('taskDescription').value = '';
      document.getElementById('taskPriority').value = 'MEDIUM';
      
      document.getElementById('taskModal').style.display = 'flex';
    }

    function closeTaskModal() {
      document.getElementById('taskModal').style.display = 'none';
    }

    async function saveTask() {
      const id = document.getElementById('taskId').value;
      const data = {
        userId: document.getElementById('taskClient').value,
        title: document.getElementById('taskTitle').value,
        description: document.getElementById('taskDescription').value,
        priority: document.getElementById('taskPriority').value,
        dueDate: document.getElementById('taskDueDate').value,
        weekStartDate: document.getElementById('taskWeekStart').value,
        weekEndDate: document.getElementById('taskWeekEnd').value,
      };
      
      try {
        const url = id ? `/api/tasks/${id}` : '/api/tasks';
        const method = id ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          alert('Task saved successfully!');
          closeTaskModal();
          loadTasks();
        } else {
          const error = await res.json();
          alert(`Error: ${error.error || 'Failed to save task'}`);
        }
      } catch (error) {
        console.error('Error saving task:', error);
        alert('Failed to save task');
      }
    }

    async function editTask(id) {
      const res = await fetch('/api/tasks', { credentials: 'include' });
      const tasks = await res.json();
      const task = tasks.find(t => t.id === id);
      
      if (!task) {
        alert('Task not found');
        return;
      }
      
      // Load clients
      const usersRes = await fetch('/api/users', { credentials: 'include' });
      const users = await usersRes.json();
      const clients = users.filter(u => u.role === 'CLIENT');
      
      const clientSelect = document.getElementById('taskClient');
      clientSelect.innerHTML = '<option value="">Select a client...</option>' + 
        clients.map(c => `<option value="${c.id}" ${c.id === task.userId ? 'selected' : ''}>${c.businessName || c.name}</option>`).join('');
      
      document.getElementById('taskModalTitle').textContent = 'Edit Task';
      document.getElementById('taskId').value = task.id;
      document.getElementById('taskTitle').value = task.title;
      document.getElementById('taskDescription').value = task.description;
      document.getElementById('taskPriority').value = task.priority;
      document.getElementById('taskDueDate').value = new Date(task.dueDate).toISOString().split('T')[0];
      document.getElementById('taskWeekStart').value = new Date(task.weekStartDate).toISOString().split('T')[0];
      document.getElementById('taskWeekEnd').value = new Date(task.weekEndDate).toISOString().split('T')[0];
      
      document.getElementById('taskModal').style.display = 'flex';
    }

    async function updateTaskStatus(id, status) {
      try {
        const res = await fetch(`/api/tasks/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ status })
        });
        
        if (res.ok) {
          loadTasks();
        } else {
          alert('Failed to update task status');
        }
      } catch (error) {
        console.error('Error updating task:', error);
        alert('Failed to update task');
      }
    }

    async function deleteTask(id) {
      if (!confirm('Are you sure you want to delete this task?')) return;
      
      try {
        const res = await fetch(`/api/tasks/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          loadTasks();
        } else {
          alert('Failed to delete task');
        }
      } catch (error) {
        console.error('Error deleting task:', error);
        alert('Failed to delete task');
      }
    }

    async function collectData() {
      try {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Collecting...';
        
        const res = await fetch('/api/collect', { method: 'POST', credentials: 'include' });
        const data = await res.json();
        
        if (res.ok) {
          alert('✅ Data collection started successfully');
          loadUsageStats(); // Refresh stats
        } else {
          alert(`❌ Error: ${data.error || 'Failed to start collection'}`);
        }
      } catch (error) {
        alert('❌ Error: Failed to start data collection');
        console.error(error);
      } finally {
        const btn = event.target;
        btn.disabled = false;
        btn.textContent = 'Collect Now';
      }
    }

    // Handle timeframe selection
    document.getElementById('reportPeriodType')?.addEventListener('change', (e) => {
      const customRange = document.getElementById('customDateRange');
      if (e.target.value === 'custom') {
        if (customRange) customRange.style.display = 'block';
      } else {
        if (customRange) customRange.style.display = 'none';
      }
    });

    function getReportParams() {
      const periodType = document.getElementById('reportPeriodType')?.value || 'week';
      const startDate = document.getElementById('reportStartDate')?.value;
      const endDate = document.getElementById('reportEndDate')?.value;
      
      const params = { periodType };
      if (periodType === 'custom' && startDate && endDate) {
        params.startDate = startDate;
        params.endDate = endDate;
      }
      return params;
    }

    async function previewReport() {
      try {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Loading...';
        
        const params = getReportParams();
        const res = await fetch('/api/preview-report', { 
          method: 'POST', 
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(params)
        });
        const data = await res.json();
        
        if (res.ok) {
          // Show preview modal
          const modal = document.getElementById('emailPreviewModal');
          const previewFrame = document.getElementById('emailPreviewFrame');
          if (previewFrame && modal) {
            previewFrame.srcdoc = data.emailHTML;
            modal.style.display = 'flex';
          }
        } else {
          alert(`❌ Error: ${data.error || 'Failed to generate preview'}`);
        }
      } catch (error) {
        alert('❌ Error: Failed to generate preview');
        console.error(error);
      } finally {
        const btn = event.target;
        btn.disabled = false;
        btn.textContent = 'Preview Email';
      }
    }

    function closePreviewModal() {
      const modal = document.getElementById('emailPreviewModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    async function sendReportFromPreview() {
      closePreviewModal();
      // Find the generate button and trigger it
      const generateBtn = document.querySelector('button[onclick*="generateReport"]');
      if (generateBtn && typeof generateBtn.click === 'function') {
        generateBtn.click();
      } else {
        // Fallback: manually trigger report generation
        await generateReportFromButton(generateBtn || null);
      }
    }

    async function generateReport() {
      await generateReportFromButton(event?.target || null);
    }

    async function generateReportFromButton(btn) {
      try {
        const button = btn || document.querySelector('button[onclick*="generateReport"]');
        if (button) {
          button.disabled = true;
          button.textContent = 'Generating...';
        }
        
        const params = getReportParams();
        const res = await fetch('/api/generate-report', { 
          method: 'POST', 
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(params)
        });
        const data = await res.json();
        
        if (res.ok) {
          alert('✅ Report generated and email sent successfully');
          loadUsageStats(); // Refresh stats
        } else {
          alert(`❌ Error: ${data.error || 'Failed to generate report'}`);
        }
      } catch (error) {
        alert('❌ Error: Failed to generate report');
        console.error(error);
      } finally {
        const button = btn || document.querySelector('button[onclick*="generateReport"]');
        if (button) {
          button.disabled = false;
          button.textContent = 'Generate Now';
        }
      }
    }

    async function loadUsageStats() {
      try {
        const res = await fetch('/api/admin/usage', { credentials: 'include' });
        if (res.ok) {
          const stats = await res.json();
          updateUsageDisplay(stats);
        }
      } catch (error) {
        console.error('Error loading usage stats:', error);
      }
    }

    function updateUsageDisplay(stats) {
      const container = document.getElementById('usageStats');
      if (!container) return;
      
      container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-4);">
          <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-radius: 8px;">
            <div style="font-size: var(--font-caption); color: var(--color-label-tertiary); margin-bottom: var(--spacing-1);">Google API Calls</div>
            <div style="font-size: 24px; font-weight: 700; color: var(--color-label-primary);">${stats.googleApiCalls || 0}</div>
            <div style="font-size: var(--font-footnote); color: var(--color-label-tertiary); margin-top: var(--spacing-1);">Last 30 days</div>
          </div>
          <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-radius: 8px;">
            <div style="font-size: var(--font-caption); color: var(--color-label-tertiary); margin-bottom: var(--spacing-1);">OpenAI API Calls</div>
            <div style="font-size: 24px; font-weight: 700; color: var(--color-label-primary);">${stats.openaiApiCalls || 0}</div>
            <div style="font-size: var(--font-footnote); color: var(--color-label-tertiary); margin-top: var(--spacing-1);">Last 30 days</div>
          </div>
          <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-radius: 8px;">
            <div style="font-size: var(--font-caption); color: var(--color-label-tertiary); margin-bottom: var(--spacing-1);">Estimated OpenAI Cost</div>
            <div style="font-size: 24px; font-weight: 700; color: var(--color-label-primary);">$${(stats.estimatedOpenAICost || 0).toFixed(3)}</div>
            <div style="font-size: var(--font-footnote); color: var(--color-label-tertiary); margin-top: var(--spacing-1);">Last 30 days</div>
          </div>
          <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-radius: 8px;">
            <div style="font-size: var(--font-caption); color: var(--color-label-tertiary); margin-bottom: var(--spacing-1);">Total Logins</div>
            <div style="font-size: 24px; font-weight: 700; color: var(--color-label-primary);">${stats.totalLogins || 0}</div>
            <div style="font-size: var(--font-footnote); color: var(--color-label-tertiary); margin-top: var(--spacing-1);">Last 30 days</div>
          </div>
        </div>
      `;
    }

    async function loadSchedules() {
      try {
        const res = await fetch('/api/admin/schedules', { credentials: 'include' });
        if (res.ok) {
          const schedules = await res.json();
          updateScheduleDisplay(schedules);
        }
      } catch (error) {
        console.error('Error loading schedules:', error);
      }
    }

    function updateScheduleDisplay(schedules) {
      const container = document.getElementById('scheduleConfig');
      if (!container) return;
      
      const dataCollection = schedules.find(s => s.jobType === 'DATA_COLLECTION') || { cronExpression: '0 3 * * *', isEnabled: true };
      const reportGeneration = schedules.find(s => s.jobType === 'REPORT_GENERATION') || { cronExpression: '0 8 * * 1', isEnabled: true };
      
      container.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
          <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-radius: 8px;">
            <h4 style="font-size: var(--font-body); font-weight: 600; margin-bottom: var(--spacing-2);">Data Collection</h4>
            <div style="margin-bottom: var(--spacing-3);">
              <label style="font-size: var(--font-footnote); color: var(--color-label-tertiary); display: block; margin-bottom: var(--spacing-1);">Schedule (Cron)</label>
              <input type="text" id="dataCollectionCron" value="${dataCollection.cronExpression}" style="width: 100%; padding: var(--spacing-2); background: var(--color-bg-secondary); border: 1px solid var(--color-separator); border-radius: 8px; color: var(--color-label-primary);">
            </div>
            <div style="margin-bottom: var(--spacing-3);">
              <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
                <input type="checkbox" id="dataCollectionEnabled" ${dataCollection.isEnabled ? 'checked' : ''}>
                <span style="font-size: var(--font-footnote); color: var(--color-label-secondary);">Enabled</span>
              </label>
            </div>
            <button class="btn btn-primary" onclick="saveSchedule('DATA_COLLECTION')" style="width: 100%;">Save</button>
          </div>
          <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-radius: 8px;">
            <h4 style="font-size: var(--font-body); font-weight: 600; margin-bottom: var(--spacing-2);">Report Generation</h4>
            <div style="margin-bottom: var(--spacing-3);">
              <label style="font-size: var(--font-footnote); color: var(--color-label-tertiary); display: block; margin-bottom: var(--spacing-1);">Schedule (Cron)</label>
              <input type="text" id="reportGenerationCron" value="${reportGeneration.cronExpression}" style="width: 100%; padding: var(--spacing-2); background: var(--color-bg-secondary); border: 1px solid var(--color-separator); border-radius: 8px; color: var(--color-label-primary);">
            </div>
            <div style="margin-bottom: var(--spacing-3);">
              <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
                <input type="checkbox" id="reportGenerationEnabled" ${reportGeneration.isEnabled ? 'checked' : ''}>
                <span style="font-size: var(--font-footnote); color: var(--color-label-secondary);">Enabled</span>
              </label>
            </div>
            <button class="btn btn-primary" onclick="saveSchedule('REPORT_GENERATION')" style="width: 100%;">Save</button>
          </div>
        </div>
      `;
    }

    async function saveSchedule(jobType) {
      try {
        const cronField = jobType === 'DATA_COLLECTION' ? 'dataCollectionCron' : 'reportGenerationCron';
        const enabledField = jobType === 'DATA_COLLECTION' ? 'dataCollectionEnabled' : 'reportGenerationEnabled';
        
        const cronExpression = document.getElementById(cronField).value;
        const isEnabled = document.getElementById(enabledField).checked;
        
        const res = await fetch('/api/admin/schedules', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ jobType, cronExpression, isEnabled })
        });
        
        if (res.ok) {
          alert('✅ Schedule updated successfully');
          loadSchedules();
        } else {
          const error = await res.json();
          alert(`❌ Error: ${error.error || 'Failed to update schedule'}`);
        }
      } catch (error) {
        alert('❌ Error: Failed to update schedule');
        console.error(error);
      }
    }

    async function impersonateUser(userId) {
      if (!confirm('View dashboard as this client? You can exit by clicking "Back to Employee Portal" or "Stop Viewing As" in the navigation.')) return;
      
      const res = await fetch('/api/auth/impersonate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ userId })
      });
      
      if (res.ok) {
        window.location.href = '/';
      } else {
        alert('Failed to impersonate user');
      }
    }

    async function handleLogout() {
      try {
        await fetch('/api/auth/logout', { 
          method: 'POST',
          credentials: 'include'
        });
        window.location.href = '/login';
      } catch (error) {
        window.location.href = '/login';
      }
    }
      </script>
    </body>
    </html>
