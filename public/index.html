<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BerganCo SEO Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* Apple Design System - Dark Mode */
    :root {
      /* Typography Scale (Apple HIG) */
      --font-large-title: 34px;
      --font-title-1: 28px;
      --font-title-2: 22px;
      --font-title-3: 20px;
      --font-body: 17px;
      --font-footnote: 13px;
      --font-caption: 12px;
      --font-caption-2: 11px;
      
      /* 8pt Grid Spacing */
      --spacing-1: 4px;
      --spacing-2: 8px;
      --spacing-3: 12px;
      --spacing-4: 16px;
      --spacing-5: 20px;
      --spacing-6: 24px;
      --spacing-8: 32px;
      
      /* Dark Mode Colors */
      --color-bg-primary: #1C1C1E;
      --color-bg-secondary: #2C2C2E;
      --color-bg-tertiary: #3A3A3C;
      --color-label-primary: #FFFFFF;
      --color-label-secondary: #E5E5EA;
      --color-label-tertiary: #98989D;
      --color-separator: #48484A;
      --color-blue: #0A84FF;
      --color-green: #30D158;
      --color-red: #FF453A;
      --color-orange: #FF9F0A;
      
      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.4);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
      background: var(--color-bg-primary);
      color: var(--color-label-primary);
      font-size: var(--font-body);
      line-height: 1.47;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    
    /* Sidebar */
    .sidebar {
      width: 240px;
      background: var(--color-bg-secondary);
      border-right: 1px solid var(--color-separator);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    
    .sidebar-header {
      padding: var(--spacing-6) var(--spacing-4);
      border-bottom: 1px solid var(--color-separator);
    }
    
    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: var(--spacing-3);
      margin-bottom: var(--spacing-2);
    }
    
    .sidebar-brand-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: var(--color-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: var(--font-body);
    }
    
    .sidebar-brand-text {
      font-size: var(--font-body);
      font-weight: 600;
      color: var(--color-label-primary);
    }
    
    .sidebar-tagline {
      font-size: var(--font-caption);
      color: var(--color-label-tertiary);
      margin-left: 44px;
    }
    
    .sidebar-nav {
      flex: 1;
      padding: var(--spacing-4) 0;
      overflow-y: auto;
    }
    
    .nav-section {
      margin-bottom: var(--spacing-6);
    }
    
    .nav-section-title {
      font-size: var(--font-caption);
      font-weight: 600;
      color: var(--color-label-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 0 var(--spacing-4);
      margin-bottom: var(--spacing-2);
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-3);
      padding: var(--spacing-2) var(--spacing-4);
      color: var(--color-label-secondary);
      text-decoration: none;
      font-size: var(--font-body);
      transition: background-color 0.2s;
      cursor: pointer;
    }
    
    .nav-item:hover {
      background: var(--color-bg-tertiary);
    }
    
    .nav-item.active {
      background: var(--color-blue);
      color: white;
    }
    
    .nav-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }
    
    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .top-bar {
      background: var(--color-bg-secondary);
      border-bottom: 1px solid var(--color-separator);
      padding: var(--spacing-4) var(--spacing-6);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .page-title {
      font-size: var(--font-title-2);
      font-weight: 700;
      color: var(--color-label-primary);
      margin-bottom: var(--spacing-1);
    }
    
    .page-subtitle {
      font-size: var(--font-footnote);
      color: var(--color-label-tertiary);
    }
    
    .date-filters {
      display: flex;
      gap: var(--spacing-2);
    }
    
    .date-filter-btn {
      padding: var(--spacing-2) var(--spacing-3);
      border-radius: 8px;
      border: 1px solid var(--color-separator);
      background: transparent;
      color: var(--color-label-secondary);
      font-size: var(--font-footnote);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .date-filter-btn:hover {
      background: var(--color-bg-tertiary);
      color: var(--color-label-primary);
    }
    
    .date-filter-btn.active {
      background: var(--color-blue);
      color: white;
      border-color: var(--color-blue);
    }
    
    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacing-6);
    }
    
    /* Cards */
    .card {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-separator);
      border-radius: 12px;
      padding: var(--spacing-6);
      box-shadow: var(--shadow-sm);
    }
    
    /* Metric Cards */
    .metric-card {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--spacing-4);
    }
    
    .metric-icon {
      width: 40px;
      height: 40px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .metric-icon.blue {
      background: rgba(10, 132, 255, 0.15);
    }
    
    .metric-icon.purple {
      background: rgba(175, 82, 222, 0.15);
    }
    
    .metric-icon.green {
      background: rgba(48, 209, 88, 0.15);
    }
    
    .metric-icon.orange {
      background: rgba(255, 159, 10, 0.15);
    }
    
    .metric-label {
      font-size: var(--font-caption);
      font-weight: 500;
      color: var(--color-label-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--spacing-2);
    }
    
    .metric-value {
      font-size: 48px;
      font-weight: 700;
      color: var(--color-label-primary);
      line-height: 1.2;
      margin-bottom: var(--spacing-2);
    }
    
    .metric-change {
      font-size: var(--font-caption);
      display: flex;
      align-items: center;
      gap: var(--spacing-1);
    }
    
    .metric-change.positive {
      color: var(--color-green);
    }
    
    .metric-change.negative {
      color: var(--color-red);
    }
    
    .metric-change.neutral {
      color: var(--color-label-tertiary);
    }
    
    /* Grid */
    .grid {
      display: grid;
      gap: var(--spacing-6);
    }
    
    .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
    .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    
    @media (min-width: 768px) {
      .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    
    @media (min-width: 1024px) {
      .lg\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    
    /* Buttons */
    .btn {
      padding: var(--spacing-2) var(--spacing-4);
      border-radius: 8px;
      font-size: var(--font-body);
      font-weight: 400;
      border: none;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .btn-primary {
      background: var(--color-blue);
      color: white;
    }
    
    .btn-primary:hover {
      opacity: 0.85;
    }
    
    .btn-secondary {
      background: transparent;
      color: var(--color-blue);
      border: 1px solid var(--color-separator);
    }
    
    .btn-secondary:hover {
      background: var(--color-bg-tertiary);
    }
    
    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--color-separator);
      border-top-color: var(--color-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Section Headers */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-4);
    }
    
    .section-title {
      font-size: var(--font-title-3);
      font-weight: 600;
      color: var(--color-label-primary);
    }
    
    .section-subtitle {
      font-size: var(--font-footnote);
      color: var(--color-label-tertiary);
      margin-top: var(--spacing-1);
    }
  </style>
</head>
<body>
  
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-brand">
        <div class="sidebar-brand-icon" id="sidebarBrandIcon">B</div>
        <div class="sidebar-brand-text" id="sidebarBrandText">BerganCo</div>
        </div>
      <div class="sidebar-tagline" id="sidebarTagline">SEO Analytics</div>
        </div>
    
    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-title">Main</div>
        <a href="/" class="nav-item active">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11V6a2 2 0 00-2-2h-4M9 21h6"/>
          </svg>
          <span>Dashboard</span>
        </a>
        <a href="/analytics" class="nav-item">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          <span>Analytics</span>
        </a>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">SEO</div>
        <a href="/pages" class="nav-item">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
          </svg>
          <span>Pages</span>
        </a>
        <a href="/queries" class="nav-item">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <span>Queries</span>
        </a>
        <a href="/settings" class="nav-item">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
            <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          <span>Settings</span>
        </a>
    </div>
      
      <div class="nav-section" id="adminNavSection" style="display: none;">
        <div class="nav-section-title">Admin</div>
        <a href="/employee" class="nav-item" id="adminNavLink">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
            <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          <span>Admin</span>
        </a>
      </div>
      
      <div class="nav-section" id="impersonationSection" style="display: none; margin-top: auto; padding-top: var(--spacing-6); border-top: 1px solid var(--color-separator);">
        <a href="/employee" class="nav-item" style="background: rgba(255, 159, 10, 0.15); color: var(--color-orange);">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M9 5l7 7-7 7"/>
          </svg>
          <span>Back to Employee Portal</span>
        </a>
        <a href="#" onclick="stopImpersonation()" class="nav-item" style="background: rgba(255, 69, 58, 0.15); color: var(--color-red);">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <span>Stop Viewing As</span>
        </a>
      </div>
      
      <div class="nav-section" style="margin-top: auto; padding-top: var(--spacing-6); border-top: 1px solid var(--color-separator);">
        <a href="#" onclick="handleLogout()" class="nav-item">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
          <span>Sign Out</span>
        </a>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Top Bar -->
    <header class="top-bar">
      <div>
        <h1 class="page-title">SEO Dashboard</h1>
        <p class="page-subtitle">Track performance and insights for www.berganco.com</p>
      </div>
      <div class="date-filters">
        <button class="date-filter-btn active" onclick="setDateFilter(7)" id="filter-7">7 Days</button>
        <button class="date-filter-btn" onclick="setDateFilter(14)" id="filter-14">14 Days</button>
        <button class="date-filter-btn" onclick="setDateFilter(30)" id="filter-30">30 Days</button>
        <button class="date-filter-btn" onclick="setDateFilter(90)" id="filter-90">90 Days</button>
      </div>
    </header>

    <!-- Content Area -->
    <main class="content-area">
    
    <!-- Loading State -->
      <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard" class="hidden">
      
        <!-- Metric Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 mb-6">
        <!-- Clicks Card -->
          <div class="card metric-card">
            <div class="metric-header">
              <div class="metric-icon blue">
                <svg width="20" height="20" fill="none" stroke="#0A84FF" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                </svg>
            </div>
            </div>
            <div class="metric-label">Total Clicks</div>
            <div class="metric-value" id="totalClicks">-</div>
            <div class="metric-change" id="clicksChange">
              <span>No comparison data</span>
          </div>
        </div>

        <!-- Impressions Card -->
          <div class="card metric-card">
            <div class="metric-header">
              <div class="metric-icon purple">
                <svg width="20" height="20" fill="none" stroke="#AF52DE" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
            </div>
            </div>
            <div class="metric-label">Impressions</div>
            <div class="metric-value" id="totalImpressions">-</div>
            <div class="metric-change" id="impressionsChange">
              <span>No comparison data</span>
          </div>
        </div>

        <!-- CTR Card -->
          <div class="card metric-card">
            <div class="metric-header">
              <div class="metric-icon green">
                <svg width="20" height="20" fill="none" stroke="#30D158" stroke-width="2" viewBox="0 0 24 24">
                  <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
            </div>
            </div>
            <div class="metric-label">Avg CTR</div>
            <div class="metric-value" id="avgCtr">-</div>
            <div class="metric-change" id="ctrChange">
              <span>No comparison data</span>
          </div>
        </div>

        <!-- Position Card -->
          <div class="card metric-card">
            <div class="metric-header">
              <div class="metric-icon orange">
                <svg width="20" height="20" fill="none" stroke="#FF9F0A" stroke-width="2" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </div>
            </div>
            <div class="metric-label">Avg Position</div>
            <div class="metric-value" id="avgPosition">-</div>
            <div class="metric-change" id="positionChange">
              <span>No comparison data</span>
            </div>
          </div>
        </div>

        <!-- AI Insights Card -->
        <div class="card mb-6">
          <div class="section-header">
            <div>
              <h2 class="section-title">AI-Powered Insights</h2>
              <p class="section-subtitle">Market-aware analysis powered by Stuchai AI</p>
            </div>
            <button class="btn btn-primary" onclick="loadAIInsights()" id="generateAI">Generate Insights</button>
          </div>
          <div id="aiInsights">
            <div style="padding: var(--spacing-8); text-align: center;">
              <p style="color: var(--color-label-tertiary); margin-bottom: var(--spacing-4);">
                Click "Generate Insights" to get AI-powered analysis for the selected time period.
              </p>
              <p style="font-size: var(--font-footnote); color: var(--color-label-tertiary);">
                This will analyze your SEO data with market context and provide actionable recommendations.
              </p>
            </div>
          </div>
        </div>

        <!-- AI Chat Assistant -->
        <div class="card mb-6">
          <div class="section-header">
            <div>
              <h2 class="section-title">Ask Stuchai AI</h2>
              <p class="section-subtitle">Ask follow-up questions about your SEO performance</p>
            </div>
          </div>
          <div id="aiChat" style="max-height: 400px; display: flex; flex-direction: column;">
            <!-- Chat Header -->
            <div style="padding: var(--spacing-3) var(--spacing-4); border-bottom: 1px solid var(--color-separator); display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: var(--font-footnote); color: var(--color-label-tertiary);">Chat with Stuchai AI</span>
              <button onclick="clearChat()" class="btn btn-secondary" style="padding: var(--spacing-1) var(--spacing-3); font-size: var(--font-footnote);">New Conversation</button>
            </div>
            <!-- Chat Messages -->
            <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: var(--spacing-4); min-height: 200px; max-height: 300px;">
              <div id="welcomeMessage" style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-radius: 12px; margin-bottom: var(--spacing-3); border: 1px solid var(--color-separator);">
                <p style="font-size: var(--font-footnote); color: var(--color-label-secondary); margin: 0;">
                  Try asking: "Why did my clicks drop?", "What should I focus on for the next week?", or "How can I improve my rankings?"
                </p>
              </div>
            </div>
            <!-- Chat Input -->
            <div style="padding: var(--spacing-4); border-top: 1px solid var(--color-separator); display: flex; gap: var(--spacing-2);">
              <input 
                type="text" 
                id="chatInput" 
                placeholder="Ask a question about your SEO data..."
                style="flex: 1; padding: var(--spacing-3); background: var(--color-bg-tertiary); border: 1px solid var(--color-separator); border-radius: 8px; color: var(--color-label-primary); font-size: var(--font-body); outline: none; transition: border-color 0.2s, box-shadow 0.2s;"
                onkeypress="if(event.key === 'Enter') sendChatMessage()"
                onfocus="this.style.borderColor = 'var(--color-blue)'; this.style.boxShadow = '0 0 0 3px rgba(10, 132, 255, 0.15)';"
                onblur="this.style.borderColor = 'var(--color-separator)'; this.style.boxShadow = 'none';"
              />
              <button class="btn btn-primary" onclick="sendChatMessage()" id="sendChatBtn">Send</button>
            </div>
          </div>
      </div>

      <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 mb-6">
          <div class="card">
            <h2 class="section-title mb-4">Clicks & Impressions Trend</h2>
            <canvas id="clicksChart" style="max-height: 300px;"></canvas>
        </div>
          <div class="card">
            <h2 class="section-title mb-4">CTR & Position Trend</h2>
            <canvas id="ctrChart" style="max-height: 300px;"></canvas>
        </div>
      </div>

      <!-- Top Pages & Queries -->
        <div class="grid grid-cols-1 lg:grid-cols-2 mb-6">
          <div class="card">
            <h2 class="section-title mb-4">Top Pages</h2>
            <div id="topPages" style="max-height: 400px; overflow-y: auto;">
              <div class="loading">
                <div class="spinner"></div>
          </div>
        </div>
          </div>
          <div class="card">
            <h2 class="section-title mb-4">Top Search Queries</h2>
            <div id="topQueries" style="max-height: 400px; overflow-y: auto;">
              <div class="loading">
                <div class="spinner"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Competitive Analysis -->
        <div class="card mb-6">
          <div class="section-header">
            <div>
              <h2 class="section-title">Competitive Analysis</h2>
              <p class="section-subtitle">Denver Property Management Market Position</p>
            </div>
            <button class="btn btn-secondary" onclick="loadCompetitors()" id="refreshCompetitors">Refresh</button>
          </div>
          <div id="competitorAnalysis">
            <div class="loading">
              <div class="spinner"></div>
      </div>
          </div>
      </div>

      <!-- Latest Report Insights -->
        <div class="card">
          <h2 class="section-title mb-4">Latest Report Insights</h2>
          <div id="reportInsights">
            <p style="color: var(--color-label-tertiary);">No reports available yet. Generate your first report to see insights.</p>
        </div>
      </div>

    </div>
  </main>
    </div>

  <script>
    let clicksChart, ctrChart;
    let currentDays = 7;

    // Format numbers
    function formatNumber(num) {
      if (num === null || num === undefined || isNaN(num)) return '-';
      return num.toLocaleString('en-US');
    }

    // Format change
    function formatChange(change, inverted = false) {
      if (change === null || change === undefined || isNaN(change)) {
        return '<span>No comparison data</span>';
      }
      
      const isPositive = inverted ? change < 0 : change > 0;
      const className = isPositive ? 'positive' : 'negative';
      const arrow = isPositive ? '↑' : '↓';
      const sign = isPositive && !inverted ? '+' : '';
      
      return `<span class="${className}">${arrow} ${sign}${Math.abs(change).toFixed(1)}${inverted ? '' : '%'}</span> <span style="color: var(--color-label-tertiary); font-size: 11px;">vs previous</span>`;
    }

    // Set date filter
    function setDateFilter(days) {
      currentDays = days;
      document.querySelectorAll('.date-filter-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`filter-${days}`).classList.add('active');
      loadDashboard();
    }

    // Load dashboard
    async function loadDashboard() {
      const loadingEl = document.getElementById('loading');
      const dashboardEl = document.getElementById('dashboard');
      
      if (!loadingEl || !dashboardEl) {
        console.error('Dashboard elements not found:', { loadingEl, dashboardEl });
        return;
      }
      
      try {
        // Show loading, hide dashboard
        loadingEl.classList.remove('hidden');
        dashboardEl.classList.add('hidden');
        
        // Load main metrics first (show immediately)
        const response = await fetch(`/api/dashboard?days=${currentDays}`, { credentials: 'include' });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Dashboard API returned ${response.status}: ${errorText || response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Dashboard data received:', data);
        
        // Always show dashboard, even if metrics are missing
        loadingEl.classList.add('hidden');
        dashboardEl.classList.remove('hidden');
        
        if (data.metrics) {
          updateMetricCards(data.metrics, {
            dataCoverage: data.metrics.dataCoverage,
            missingDays: data.diagnostics?.missingDays || 0
          });
        } else {
          console.warn('No metrics data received');
          // Show placeholder values if no metrics
          document.getElementById('totalClicks').textContent = '-';
          document.getElementById('totalImpressions').textContent = '-';
          document.getElementById('avgCtr').textContent = '-';
          document.getElementById('avgPosition').textContent = '-';
        }
        
        if (data.latestReport) {
          updateReportInsights(data.latestReport);
        }

        // Load secondary content (charts, lists) in parallel after metrics are shown
        Promise.all([
          loadTrends(currentDays),
          loadTopPages(currentDays),
          loadTopQueries(currentDays),
          loadCompetitors()
        ]).catch(error => {
          console.error('Error loading secondary content:', error);
          // Don't block UI if secondary content fails
        });
      } catch (error) {
        console.error('Error loading dashboard:', error);
        const loadingEl = document.getElementById('loading');
        const dashboardEl = document.getElementById('dashboard');
        
        if (loadingEl) loadingEl.classList.add('hidden');
        if (dashboardEl) dashboardEl.classList.remove('hidden');
        
        // Show error message to user
        const errorMsg = document.createElement('div');
        errorMsg.style.cssText = 'padding: var(--spacing-4); background: rgba(255, 59, 48, 0.15); border: 1px solid var(--color-red); border-radius: 8px; margin-bottom: var(--spacing-4); color: var(--color-red);';
        errorMsg.textContent = `Failed to load dashboard data: ${error instanceof Error ? error.message : 'Unknown error'}`;
        const contentArea = document.querySelector('.content-area') || document.querySelector('main');
        if (contentArea) {
          contentArea.insertBefore(errorMsg, contentArea.firstChild);
        }
      }
    }

    // Update metric cards
    function updateMetricCards(metrics, diagnostics) {
      // Show data coverage warning if needed
      if (diagnostics && diagnostics.dataCoverage < 100) {
        const missingDays = diagnostics.missingDays || 0;
        if (missingDays > 0) {
          const warningMsg = `⚠️ Missing data for ${missingDays} day${missingDays > 1 ? 's' : ''}. Numbers may be lower than Google Search Console. Click "Collect Now" in Employee Portal to sync missing days.`;
          // Remove existing warning if any
          const existingWarning = document.getElementById('dataCoverageWarning');
          if (existingWarning) {
            existingWarning.remove();
          }
        
        // Show data coverage warning
        const warning = document.createElement('div');
        warning.id = 'dataCoverageWarning';
        warning.style.cssText = 'padding: var(--spacing-3) var(--spacing-4); background: rgba(255, 159, 10, 0.15); border: 1px solid var(--color-orange); border-radius: 8px; margin-bottom: var(--spacing-4); color: var(--color-orange); font-size: var(--font-footnote); display: flex; align-items: center; gap: var(--spacing-2);';
        warning.innerHTML = `
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <span>${warningMsg}</span>
        `;
        const dashboardContent = document.querySelector('.content-area') || document.querySelector('main');
        const metricsGrid = document.querySelector('.grid.grid-cols-4') || document.querySelector('.grid');
        if (dashboardContent && metricsGrid) {
          dashboardContent.insertBefore(warning, metricsGrid);
        } else if (dashboardContent && dashboardContent.firstChild) {
          dashboardContent.insertBefore(warning, dashboardContent.firstChild);
        }
      } else {
        // Remove warning if data coverage is 100%
        const existingWarning = document.getElementById('dataCoverageWarning');
        if (existingWarning) {
          existingWarning.remove();
        }
      }
      document.getElementById('totalClicks').textContent = formatNumber(metrics.totalClicks);
      document.getElementById('clicksChange').innerHTML = formatChange(metrics.clicksChange);

      document.getElementById('totalImpressions').textContent = formatNumber(metrics.totalImpressions);
      document.getElementById('impressionsChange').innerHTML = formatChange(metrics.impressionsChange);

      const ctr = metrics.averageCtr ? (metrics.averageCtr * 100).toFixed(2) + '%' : '-';
      document.getElementById('avgCtr').textContent = ctr;
      document.getElementById('ctrChange').innerHTML = formatChange(metrics.ctrChange);

      const position = metrics.averagePosition ? metrics.averagePosition.toFixed(1) : '-';
      document.getElementById('avgPosition').textContent = position;
      document.getElementById('positionChange').innerHTML = formatChange(metrics.positionChange, true);
    }

    // Load trends
    async function loadTrends(days) {
      try {
        const response = await fetch(`/api/trends?days=${days}`);
        const data = await response.json();

        if (!data || data.length === 0) return;

        const dates = data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        const clicks = data.map(d => d.clicks);
        const impressions = data.map(d => d.impressions);
        const ctrs = data.map(d => d.ctr * 100);
        const positions = data.map(d => d.position);

        // Clicks Chart
        const clicksCtx = document.getElementById('clicksChart').getContext('2d');
        if (clicksChart) clicksChart.destroy();
        clicksChart = new Chart(clicksCtx, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [
              {
                label: 'Clicks',
                data: clicks,
                borderColor: '#0A84FF',
                backgroundColor: 'rgba(10, 132, 255, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2
              },
              {
                label: 'Impressions',
                data: impressions,
                borderColor: '#AF52DE',
                backgroundColor: 'rgba(175, 82, 222, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: '#E5E5EA', font: { family: '-apple-system', size: 12 } }
              }
            },
            scales: {
              x: { grid: { color: '#48484A' }, ticks: { color: '#98989D' } },
              y: { grid: { color: '#48484A' }, ticks: { color: '#98989D' }, beginAtZero: true },
              y1: { grid: { drawOnChartArea: false }, ticks: { color: '#98989D' }, position: 'right', beginAtZero: true }
            }
          }
        });

        // CTR Chart
        const ctrCtx = document.getElementById('ctrChart').getContext('2d');
        if (ctrChart) ctrChart.destroy();
        ctrChart = new Chart(ctrCtx, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [
              {
                label: 'CTR (%)',
                data: ctrs,
                borderColor: '#30D158',
                backgroundColor: 'rgba(48, 209, 88, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2
              },
              {
                label: 'Position',
                data: positions,
                borderColor: '#FF9F0A',
                backgroundColor: 'rgba(255, 159, 10, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: '#E5E5EA', font: { family: '-apple-system', size: 12 } }
              }
            },
            scales: {
              x: { grid: { color: '#48484A' }, ticks: { color: '#98989D' } },
              y: { grid: { color: '#48484A' }, ticks: { color: '#98989D' }, beginAtZero: true },
              y1: { grid: { drawOnChartArea: false }, ticks: { color: '#98989D', reverse: true }, position: 'right', beginAtZero: true }
            }
          }
        });
      } catch (error) {
        console.error('Error loading trends:', error);
      }
    }

    // Load top pages
    async function loadTopPages(days) {
      try {
        const response = await fetch(`/api/top-pages?days=${days}&limit=10`);
        const data = await response.json();

        if (!data || data.length === 0) {
          document.getElementById('topPages').innerHTML = '<p style="color: var(--color-label-tertiary); text-align: center; padding: var(--spacing-8) 0;">No page data available</p>';
          return;
        }

        const html = data.map(page => {
          const url = page.page.replace('https://www.berganco.com', '') || '/';
          return `
            <div style="padding: var(--spacing-3) 0; border-bottom: 1px solid var(--color-separator);">
              <div style="font-size: var(--font-body); font-weight: 500; color: var(--color-label-primary); margin-bottom: var(--spacing-1);">${url}</div>
              <div style="font-size: var(--font-caption); color: var(--color-label-tertiary);">
                ${formatNumber(page._sum.clicks)} clicks · ${((page._avg.ctr || 0) * 100).toFixed(2)}% CTR · ${formatNumber(page._sum.impressions)} impressions
              </div>
            </div>
          `;
        }).join('');

        document.getElementById('topPages').innerHTML = html;
      } catch (error) {
        console.error('Error loading pages:', error);
      }
    }

    // Load top queries
    async function loadTopQueries(days) {
      try {
        const response = await fetch(`/api/top-queries?days=${days}&limit=10`);
        const data = await response.json();

        if (!data || data.length === 0) {
          document.getElementById('topQueries').innerHTML = '<p style="color: var(--color-label-tertiary); text-align: center; padding: var(--spacing-8) 0;">No query data available</p>';
          return;
        }

        const html = data.map(query => {
          return `
            <div style="padding: var(--spacing-3) 0; border-bottom: 1px solid var(--color-separator);">
              <div style="font-size: var(--font-body); font-weight: 500; color: var(--color-label-primary); margin-bottom: var(--spacing-1);">"${query.query}"</div>
              <div style="font-size: var(--font-caption); color: var(--color-label-tertiary);">
                ${formatNumber(query._sum.clicks)} clicks · ${((query._avg.ctr || 0) * 100).toFixed(2)}% CTR · Position ${(query._avg.position || 0).toFixed(1)}
              </div>
            </div>
          `;
        }).join('');

        document.getElementById('topQueries').innerHTML = html;
      } catch (error) {
        console.error('Error loading queries:', error);
      }
    }

    // Load AI insights
    async function loadAIInsights() {
      try {
        const button = document.getElementById('generateAI');
        if (button) {
          button.disabled = true;
          button.textContent = 'Generating...';
        }

        // Show loading state
        document.getElementById('aiInsights').innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <p style="color: var(--color-label-secondary); margin-top: var(--spacing-3);">Analyzing your SEO data with Stuchai AI...</p>
          </div>
        `;

        const response = await fetch(`/api/ai-insights?days=${currentDays}`);
        const data = await response.json();

        if (data.insight) {
          document.getElementById('aiInsights').innerHTML = `
            <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border: 1px solid var(--color-separator); border-radius: 12px;">
              <p style="font-size: var(--font-body); color: var(--color-label-primary); line-height: 1.6; margin: 0;">${data.insight}</p>
              <p style="font-size: var(--font-caption); color: var(--color-label-tertiary); margin-top: var(--spacing-2);">
                Generated ${new Date(data.generatedAt).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}
              </p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading AI insights:', error);
      } finally {
        const button = document.getElementById('generateAI');
        if (button) {
          button.disabled = false;
          button.textContent = 'Generate Insights';
        }
      }
    }

    // Send chat message
    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;

      const sendBtn = document.getElementById('sendChatBtn');
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';
      input.disabled = true;

      // Add user message to chat
      addChatMessage('user', message);
      chatMessages.push({ role: 'user', content: message });
      input.value = '';

      // Add loading message
      const loadingId = addChatMessage('assistant', 'Thinking...', true);

      try {
        // Get current dashboard metrics for context
        const dashboardResponse = await fetch(`/api/dashboard?days=${currentDays}`);
        const dashboardData = await dashboardResponse.json();

        const response = await fetch('/api/ai-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            context: {
              days: currentDays,
              metrics: dashboardData.metrics,
              topPages: dashboardData.latestMetrics?.slice(0, 5) || [],
            }
          })
        });

        const data = await response.json();
        
        // Remove loading message and add AI response
        removeChatMessage(loadingId);
        const aiResponse = data.response || 'I apologize, but I encountered an error. Please try again.';
        addChatMessage('assistant', aiResponse);
        chatMessages.push({ role: 'assistant', content: aiResponse });
      } catch (error) {
        console.error('Error sending chat message:', error);
        removeChatMessage(loadingId);
        addChatMessage('assistant', 'Sorry, I encountered an error. Please try again.');
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
        input.disabled = false;
        input.focus();
      }
    }

    // Add message to chat
    function addChatMessage(role, message, isLoading = false) {
      const messagesDiv = document.getElementById('chatMessages');
      const messageId = 'msg-' + Date.now();
      
      const isUser = role === 'user';
      const alignStyle = isUser ? 'margin-left: 20%;' : 'margin-right: 20%;';
      const bgColor = isUser ? 'var(--color-blue)' : 'var(--color-bg-tertiary)';
      const textColor = isUser ? 'white' : 'var(--color-label-primary)';

      const messageDiv = document.createElement('div');
      messageDiv.id = messageId;
      messageDiv.style.cssText = `${alignStyle} margin-bottom: var(--spacing-3);`;
      
      messageDiv.innerHTML = `
        <div style="padding: var(--spacing-3) var(--spacing-4); background: ${bgColor}; border-radius: 12px; display: inline-block; max-width: 100%;">
          <p style="font-size: var(--font-body); color: ${textColor}; margin: 0; line-height: 1.6; white-space: pre-wrap;">${message}</p>
          ${isLoading ? '<div class="spinner" style="width: 16px; height: 16px; margin-top: var(--spacing-2);"></div>' : ''}
        </div>
      `;

      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      return messageId;
    }

    // Remove message from chat
    function removeChatMessage(messageId) {
      const msg = document.getElementById(messageId);
      if (msg) msg.remove();
    }

    // Clear chat conversation
    function clearChat() {
      const messagesDiv = document.getElementById('chatMessages');
      messagesDiv.innerHTML = `
        <div id="welcomeMessage" style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-radius: 12px; margin-bottom: var(--spacing-3); border: 1px solid var(--color-separator);">
          <p style="font-size: var(--font-footnote); color: var(--color-label-secondary); margin: 0;">
            Try asking: "Why did my clicks drop?", "What should I focus on for the next week?", or "How can I improve my rankings?"
          </p>
        </div>
      `;
      chatMessages = [];
    }

    let chatMessages = [];

    // Update sidebar branding
    function updateSidebarBranding(user) {
      const brandIcon = document.getElementById('sidebarBrandIcon');
      const brandText = document.getElementById('sidebarBrandText');
      const brandTagline = document.getElementById('sidebarTagline');
      
      if (user.logoUrl) {
        brandIcon.innerHTML = `<img src="${user.logoUrl}" alt="${user.businessName || 'Company'}" style="width: 32px; height: 32px; border-radius: 8px; object-fit: cover;">`;
      } else {
        const initial = (user.businessName || 'B')[0].toUpperCase();
        brandIcon.textContent = initial;
      }
      
      // Always use business name, fall back to default
      if (user.businessName) {
        brandText.textContent = user.businessName;
        brandTagline.textContent = `${user.businessName} SEO Analytics`;
      } else {
        brandText.textContent = 'BerganCo';
        brandTagline.textContent = 'SEO Analytics';
      }
    }

    // Load competitive analysis
    async function loadCompetitors() {
      try {
        const button = document.getElementById('refreshCompetitors');
        if (button) {
          button.disabled = true;
          button.textContent = 'Refreshing...';
        }

        const response = await fetch('/api/competitors');
        const data = await response.json();

        if (data.topCompetitors && data.topCompetitors.length > 0) {
          // Rank competitors
          const rankedCompetitors = data.topCompetitors.map((comp, idx) => {
            const position = idx + 1;
            return { ...comp, position };
          });

          const html = `
            <div style="margin-bottom: var(--spacing-6);">
              <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-radius: 12px; margin-bottom: var(--spacing-4);">
                <h3 style="font-size: var(--font-title-3); font-weight: 600; color: var(--color-label-primary); margin-bottom: var(--spacing-2);">
                  Market Position: ${data.summary.split('.')[0]}
                </h3>
                <p style="font-size: var(--font-body); color: var(--color-label-secondary); line-height: 1.6; margin: 0;">
                  ${data.summary}
                </p>
              </div>

              <div style="margin-bottom: var(--spacing-6);">
                <h3 style="font-size: var(--font-title-3); font-weight: 600; color: var(--color-label-primary); margin-bottom: var(--spacing-4);">
                  Competitor Rankings
                </h3>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-3);">
                  ${rankedCompetitors.map(comp => `
                    <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border: 1px solid var(--color-separator); border-radius: 12px;">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-3);">
                        <div style="flex: 1;">
                          <div style="display: flex; align-items: center; gap: var(--spacing-3); margin-bottom: var(--spacing-2);">
                            <div style="width: 32px; height: 32px; border-radius: 16px; background: ${comp.position <= 3 ? 'var(--color-blue)' : 'var(--color-bg-secondary)'}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                              <span style="font-size: var(--font-footnote); font-weight: 700; color: ${comp.position <= 3 ? 'white' : 'var(--color-label-secondary)'};">
                                ${comp.position}
                              </span>
                            </div>
                            <div style="flex: 1;">
                              <div style="font-size: var(--font-body); font-weight: 600; color: var(--color-label-primary);">${comp.name}</div>
                              <div style="font-size: var(--font-footnote); color: var(--color-label-tertiary); margin-top: var(--spacing-1);">${comp.domain}</div>
                            </div>
                          </div>
                          <div style="display: flex; flex-direction: column; gap: var(--spacing-2); margin-top: var(--spacing-3);">
                            <div style="font-size: var(--font-caption); font-weight: 600; color: var(--color-label-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--spacing-1);">
                              What They Do Well:
                            </div>
                            ${comp.strengths.map(strength => `
                              <div style="display: flex; align-items: start; gap: var(--spacing-2);">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0; margin-top: 2px;">
                                  <circle cx="8" cy="8" r="7" stroke="#30D158" stroke-width="1.5"/>
                                  <path d="M5 8l2 2 4-4" stroke="#30D158" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span style="font-size: var(--font-footnote); color: var(--color-label-secondary); line-height: 1.5;">${strength}</span>
                              </div>
                            `).join('')}
                          </div>
                        </div>
                        <div style="text-align: right; margin-left: var(--spacing-4);">
                          <div style="font-size: var(--font-footnote); color: var(--color-label-tertiary); margin-bottom: var(--spacing-1);">
                            Est. Traffic
                          </div>
                          <div style="font-size: var(--font-body); font-weight: 600; color: var(--color-label-primary);">
                            ${comp.estimatedTraffic ? formatNumber(comp.estimatedTraffic) : 'N/A'}
                          </div>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
                <div>
                  <h3 style="font-size: var(--font-title-3); font-weight: 600; color: var(--color-label-primary); margin-bottom: var(--spacing-3);">
                    BerganCo Advantages
                  </h3>
                  <div style="display: flex; flex-direction: column; gap: var(--spacing-2);">
                    ${data.bergancoAdvantages.map(adv => `
                      <div style="padding: var(--spacing-3); background: rgba(48, 209, 88, 0.1); border-left: 3px solid var(--color-green); border-radius: 8px;">
                        <span style="font-size: var(--font-footnote); color: var(--color-label-primary);">${adv}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
                <div>
                  <h3 style="font-size: var(--font-title-3); font-weight: 600; color: var(--color-label-primary); margin-bottom: var(--spacing-3);">
                    Areas to Improve
                  </h3>
                  <div style="display: flex; flex-direction: column; gap: var(--spacing-2);">
                    ${data.competitorAdvantages.map(area => `
                      <div style="padding: var(--spacing-3); background: rgba(255, 69, 58, 0.1); border-left: 3px solid var(--color-red); border-radius: 8px;">
                        <span style="font-size: var(--font-footnote); color: var(--color-label-primary);">${area}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
            </div>
          `;

          document.getElementById('competitorAnalysis').innerHTML = html;
        } else {
          document.getElementById('competitorAnalysis').innerHTML = `
            <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border: 1px solid var(--color-separator); border-radius: 12px;">
              <p style="color: var(--color-label-tertiary); text-align: center;">Unable to load competitive analysis data.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading competitors:', error);
        document.getElementById('competitorAnalysis').innerHTML = `
          <div style="padding: var(--spacing-4); background: rgba(255, 69, 58, 0.1); border: 1px solid var(--color-red); border-radius: 12px;">
            <p style="color: var(--color-red); text-align: center;">Error loading competitive analysis. Please try again.</p>
          </div>
        `;
      } finally {
        const button = document.getElementById('refreshCompetitors');
        if (button) {
          button.disabled = false;
          button.textContent = 'Refresh';
        }
      }
    }

    // Update report insights
    function updateReportInsights(report) {
      const insights = report.insights ? report.insights.split('\n').join('<br>') : 'No insights available.';
      const recommendations = report.recommendations ? report.recommendations.split('\n').join('<br>') : '';

      document.getElementById('reportInsights').innerHTML = `
        <div style="margin-bottom: var(--spacing-6);">
          <h3 style="font-size: var(--font-title-3); font-weight: 600; color: var(--color-label-primary); margin-bottom: var(--spacing-3);">Insights</h3>
          <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-left: 3px solid #FF9F0A; border-radius: 12px;">
            <p style="font-size: var(--font-body); color: var(--color-label-primary); line-height: 1.6; margin: 0;">${insights}</p>
          </div>
        </div>
        ${recommendations ? `
        <div>
          <h3 style="font-size: var(--font-title-3); font-weight: 600; color: var(--color-label-primary); margin-bottom: var(--spacing-3);">Recommendations</h3>
          <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-left: 3px solid #0A84FF; border-radius: 12px;">
            <p style="font-size: var(--font-body); color: var(--color-label-primary); line-height: 1.6; margin: 0;">${recommendations}</p>
          </div>
        </div>
        ` : ''}
      `;
    }

    // Check authentication and load dashboard
    async function init() {
      try {
        const response = await fetch('/api/auth/me', { credentials: 'include' });
        if (response.ok) {
          const data = await response.json();
          if (data.user) {
            // Redirect admins/employees to employee portal (unless impersonating)
            const originalAdminToken = getCookie('originalAdminToken');
            if (data.user.role !== 'CLIENT' && !originalAdminToken) {
              window.location.href = '/employee';
              return;
            }
            
            // Update sidebar branding
            try {
              updateSidebarBranding(data.user);
            } catch (e) {
              console.error('Error updating sidebar:', e);
            }
            
            // Check if impersonating
            try {
              if (originalAdminToken && data.user.role === 'CLIENT') {
                const impersonationSection = document.getElementById('impersonationSection');
                if (impersonationSection) {
                  impersonationSection.style.display = 'block';
                }
              }
              
              // Show admin section if employee/admin
              if (data.user.role !== 'CLIENT') {
                const adminNavSection = document.getElementById('adminNavSection');
                if (adminNavSection) {
                  adminNavSection.style.display = 'block';
                }
              }
            } catch (e) {
              console.error('Error updating navigation:', e);
            }
            
            // Load dashboard after auth check passes
            loadDashboard();
          } else {
            // Redirect to login if not authenticated
            window.location.href = '/login';
            return;
          }
        } else {
          window.location.href = '/login';
          return;
        }
      } catch (error) {
        console.error('Auth error:', error);
        // Show dashboard anyway, let loadDashboard handle errors
        const loadingEl = document.getElementById('loading');
        const dashboardEl = document.getElementById('dashboard');
        if (loadingEl) loadingEl.classList.add('hidden');
        if (dashboardEl) dashboardEl.classList.remove('hidden');
        
        // Try to load dashboard even if auth check failed (might be CORS or network issue)
        try {
          loadDashboard();
        } catch (e) {
          console.error('Failed to load dashboard:', e);
        }
      }
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    async function stopImpersonation() {
      const res = await fetch('/api/auth/stop-impersonate', {
        method: 'POST',
        credentials: 'include'
      });
      
      if (res.ok) {
        const data = await res.json();
        // Update session token and redirect
        window.location.href = '/employee';
      } else {
        const error = await res.json();
        alert(`Failed to stop impersonation: ${error.error || 'Unknown error'}`);
      }
    }
    
    async function handleLogout() {
      try {
        await fetch('/api/auth/logout', { 
          method: 'POST',
          credentials: 'include'
        });
        window.location.href = '/login.html';
      } catch (error) {
        window.location.href = '/login.html';
      }
    }
    
    init();
  </script>

</body>
</html>