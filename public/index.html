<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BerganCo SEO Dashboard</title>
  <link rel="icon" type="image/png" href="https://framerusercontent.com/images/AhyGPdkv1Kr9JeLtiQvJBU0uJE.png?scale-down-to=1024&width=2088&height=518">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* Apple Design System - Dark Mode */
    :root {
      /* Typography Scale (Apple HIG) */
      --font-large-title: 34px;
      --font-title-1: 28px;
      --font-title-2: 22px;
      --font-title-3: 20px;
      --font-body: 17px;
      --font-footnote: 13px;
      --font-caption: 12px;
      --font-caption-2: 11px;
      
      /* 8pt Grid Spacing */
      --spacing-1: 4px;
      --spacing-2: 8px;
      --spacing-3: 12px;
      --spacing-4: 16px;
      --spacing-5: 20px;
      --spacing-6: 24px;
      --spacing-8: 32px;
      
      /* Dark Mode Colors */
      --color-bg-primary: #1C1C1E;
      --color-bg-secondary: #2C2C2E;
      --color-bg-tertiary: #3A3A3C;
      --color-label-primary: #FFFFFF;
      --color-label-secondary: #E5E5EA;
      --color-label-tertiary: #98989D;
      --color-separator: #48484A;
      --color-blue: #0A84FF;
      --color-green: #30D158;
      --color-red: #FF453A;
      --color-orange: #FF9F0A;
      
      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.4);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
      background: var(--color-bg-primary);
      color: var(--color-label-primary);
      font-size: var(--font-body);
      line-height: 1.47;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    
    /* Sidebar */
    .sidebar {
      width: 240px;
      background: rgba(44, 44, 46, 0.7);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-right: 0.5px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      box-shadow: inset -1px 0 0 0 rgba(255, 255, 255, 0.05);
    }
    
    .sidebar-header {
      padding: var(--spacing-6) var(--spacing-4);
      border-bottom: 1px solid var(--color-separator);
    }
    
    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: var(--spacing-3);
      margin-bottom: var(--spacing-2);
    }
    
    .sidebar-brand-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: var(--color-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: var(--font-body);
    }
    
    .sidebar-brand-text {
      font-size: var(--font-body);
      font-weight: 600;
      color: var(--color-label-primary);
    }
    
    .sidebar-tagline {
      font-size: var(--font-caption);
      color: var(--color-label-tertiary);
      margin-left: 44px;
    }
    
    .sidebar-nav {
      flex: 1;
      padding: var(--spacing-4) 0;
      overflow-y: auto;
    }
    
    .nav-section {
      margin-bottom: var(--spacing-6);
    }
    
    .nav-section-title {
      font-size: var(--font-caption);
      font-weight: 600;
      color: var(--color-label-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 0 var(--spacing-4);
      margin-bottom: var(--spacing-2);
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-3);
      padding: var(--spacing-2) var(--spacing-4);
      color: var(--color-label-secondary);
      text-decoration: none;
      font-size: var(--font-body);
      transition: background-color 0.2s;
      cursor: pointer;
    }
    
    .nav-item:hover {
      background: var(--color-bg-tertiary);
    }
    
    .nav-item.active {
      background: var(--color-blue);
      color: white;
    }
    
    .nav-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }
    
    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .top-bar {
      background: rgba(44, 44, 46, 0.7);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
      padding: var(--spacing-4) var(--spacing-6);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      box-shadow: 0 1px 0 0 rgba(255, 255, 255, 0.05);
    }
    
    .page-title {
      font-size: var(--font-title-2);
      font-weight: 700;
      color: var(--color-label-primary);
      margin-bottom: var(--spacing-1);
    }
    
    .page-subtitle {
      font-size: var(--font-footnote);
      color: var(--color-label-tertiary);
    }
    
    .date-filters {
      display: flex;
      gap: var(--spacing-2);
    }
    
    .date-filter-btn {
      padding: var(--spacing-2) var(--spacing-3);
      border-radius: 8px;
      border: 1px solid var(--color-separator);
      background: transparent;
      color: var(--color-label-secondary);
      font-size: var(--font-footnote);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .date-filter-btn:hover {
      background: var(--color-bg-tertiary);
      color: var(--color-label-primary);
    }
    
    .date-filter-btn.active {
      background: var(--color-blue);
      color: white;
      border-color: var(--color-blue);
    }
    
    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacing-6);
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 1px solid var(--color-separator);
      }
      
      .main-content {
        width: 100%;
      }
      
      .content-area {
        padding: var(--spacing-4);
        overflow-x: hidden;
        width: 100%;
      }
      
      .top-bar {
        flex-direction: column;
        align-items: flex-start !important;
        gap: var(--spacing-3) !important;
        padding: var(--spacing-3) var(--spacing-4);
      }
      
      .top-bar > div:first-child {
        width: 100%;
      }
      
      .top-bar > div:last-child {
        width: 100%;
      }
      
      .date-filters {
        width: 100%;
        flex-wrap: wrap;
        gap: var(--spacing-1);
      }
      
      .date-filter-btn {
        flex: 1;
        min-width: 70px;
        font-size: var(--font-caption);
        padding: var(--spacing-1) var(--spacing-2);
      }
      
      .grid {
        grid-template-columns: 1fr !important;
        gap: var(--spacing-3);
      }
      
      .card {
        padding: var(--spacing-4);
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
      }
      
      /* Chart containers - mobile responsive */
      .chart-container {
        position: relative;
        width: 100% !important;
        max-width: 100% !important;
        height: 250px !important;
        margin: 0;
        padding: 0;
        overflow: hidden;
        box-sizing: border-box;
      }
      
      .chart-container canvas {
        max-width: 100% !important;
        width: 100% !important;
        height: 100% !important;
      }
      
      .metric-card {
        padding: var(--spacing-4);
      }
      
      .metric-value {
        font-size: 32px !important;
      }
      
      /* Ensure no horizontal overflow */
      * {
        max-width: 100%;
        box-sizing: border-box;
      }
    }
    
    /* Cards */
    .card {
      background: rgba(44, 44, 46, 0.6);
      backdrop-filter: blur(30px) saturate(180%);
      -webkit-backdrop-filter: blur(30px) saturate(180%);
      border: 0.5px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: var(--spacing-6);
      box-shadow: 
        0 8px 32px 0 rgba(0, 0, 0, 0.4),
        inset 0 1px 0 0 rgba(255, 255, 255, 0.08);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      background: rgba(44, 44, 46, 0.7);
      box-shadow: 
        0 12px 40px 0 rgba(0, 0, 0, 0.5),
        inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
    }
    
    /* Chart Container - Responsive */
    .chart-container {
      position: relative;
      width: 100%;
      max-width: 100%;
      height: 300px;
      margin: 0 auto;
    }
    
    .chart-container canvas {
      max-width: 100% !important;
      height: auto !important;
    }
    
    /* Metric Cards */
    .metric-card {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--spacing-4);
    }
    
    .metric-icon {
      width: 40px;
      height: 40px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .metric-icon.blue {
      background: rgba(10, 132, 255, 0.15);
    }
    
    .metric-icon.purple {
      background: rgba(175, 82, 222, 0.15);
    }
    
    .metric-icon.green {
      background: rgba(48, 209, 88, 0.15);
    }
    
    .metric-icon.orange {
      background: rgba(255, 159, 10, 0.15);
    }
    
    .metric-label {
      font-size: var(--font-caption);
      font-weight: 500;
      color: var(--color-label-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--spacing-2);
    }
    
    .metric-value {
      font-size: 48px;
      font-weight: 700;
      color: var(--color-label-primary);
      line-height: 1.2;
      margin-bottom: var(--spacing-2);
    }
    
    .metric-change {
      font-size: var(--font-caption);
      display: flex;
      align-items: center;
      gap: var(--spacing-1);
    }
    
    .metric-change.positive {
      color: var(--color-green);
    }
    
    .metric-change.negative {
      color: var(--color-red);
    }
    
    .metric-change.neutral {
      color: var(--color-label-tertiary);
    }
    
    /* Grid */
    .grid {
      display: grid;
      gap: var(--spacing-6);
    }
    
    .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
    .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    
    @media (min-width: 768px) {
      .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    
    @media (min-width: 1024px) {
      .lg\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    
    /* Buttons */
    .btn {
      padding: var(--spacing-2) var(--spacing-4);
      border-radius: 8px;
      font-size: var(--font-body);
      font-weight: 400;
      border: none;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .btn-primary {
      background: var(--color-blue);
      color: white;
    }
    
    .btn-primary:hover {
      opacity: 0.85;
    }
    
    /* AI Glow Effect - Brand Aligned (Blue Gradient) */
    .btn-ai-glow {
      position: relative;
      background: var(--color-bg-secondary);
      color: var(--color-label-primary);
      border: 1.5px solid transparent;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(10, 132, 255, 0.3), 0 0 40px rgba(10, 132, 255, 0.15);
    }
    
    .btn-ai-glow::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 12px;
      padding: 2px;
      background: linear-gradient(90deg, 
        rgba(10, 132, 255, 0.9) 0%,
        rgba(10, 132, 255, 0.5) 25%,
        rgba(94, 92, 230, 0.7) 50%,
        rgba(10, 132, 255, 0.5) 75%,
        rgba(10, 132, 255, 0.9) 100%);
      background-size: 200% 100%;
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      animation: aiGlowRotate 3s ease-in-out infinite;
      z-index: -1;
    }
    
    @keyframes aiGlowRotate {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* Alternative AI Glow with pulsing border */
    .btn-ai-glow::after {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 12px;
      border: 1.5px solid rgba(10, 132, 255, 0.6);
      opacity: 0;
      animation: aiGlowPulse 2s ease-in-out infinite;
      z-index: -2;
    }
    
    @keyframes aiGlowPulse {
      0%, 100% { opacity: 0; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.02); }
    }
    
    .btn-ai-glow:hover {
      box-shadow: 0 0 30px rgba(10, 132, 255, 0.5), 0 0 60px rgba(10, 132, 255, 0.25);
      transform: translateY(-1px);
      transition: all 0.3s ease;
    }
    
    .btn-ai-glow:active {
      transform: translateY(0);
    }
    
    /* Apple Liquid Glass Effect */
    .liquid-glass {
      background: rgba(44, 44, 46, 0.7);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 0.5px solid rgba(255, 255, 255, 0.1);
      box-shadow: 
        0 8px 32px 0 rgba(0, 0, 0, 0.37),
        inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
    }
    
    .liquid-glass-card {
      background: rgba(44, 44, 46, 0.6);
      backdrop-filter: blur(30px) saturate(180%);
      -webkit-backdrop-filter: blur(30px) saturate(180%);
      border: 0.5px solid rgba(255, 255, 255, 0.08);
      box-shadow: 
        0 8px 32px 0 rgba(0, 0, 0, 0.4),
        inset 0 1px 0 0 rgba(255, 255, 255, 0.08);
    }
    
    .btn-secondary {
      background: transparent;
      color: var(--color-blue);
      border: 1px solid var(--color-separator);
    }
    
    .btn-secondary:hover {
      background: var(--color-bg-tertiary);
    }
    
    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--color-separator);
      border-top-color: var(--color-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Section Headers */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-4);
    }
    
    .section-title {
      font-size: var(--font-title-3);
      font-weight: 600;
      color: var(--color-label-primary);
    }
    
    .section-subtitle {
      font-size: var(--font-footnote);
      color: var(--color-label-tertiary);
      margin-top: var(--spacing-1);
    }
  </style>
</head>
<body>
  
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-brand">
        <div class="sidebar-brand-icon" id="sidebarBrandIcon">B</div>
        <div class="sidebar-brand-text" id="sidebarBrandText">BerganCo</div>
        </div>
      <div class="sidebar-tagline" id="sidebarTagline">SEO Analytics</div>
        </div>
    
    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-title">Main</div>
        <a href="/" class="nav-item active">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11V6a2 2 0 00-2-2h-4M9 21h6"/>
          </svg>
          <span>Dashboard</span>
        </a>
        <a href="/analytics" class="nav-item">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          <span>Analytics</span>
        </a>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">SEO</div>
        <a href="/pages" class="nav-item">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
          </svg>
          <span>Pages</span>
        </a>
        <a href="/queries" class="nav-item">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <span>Queries</span>
        </a>
        <a href="/settings" class="nav-item">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
            <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          <span>Settings</span>
        </a>
    </div>
      
      <div class="nav-section" id="adminNavSection" style="display: none;">
        <div class="nav-section-title">Admin</div>
        <a href="/employee" class="nav-item" id="adminNavLink">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
            <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          <span>Admin</span>
        </a>
      </div>
      
      <div class="nav-section" id="impersonationSection" style="display: none; margin-top: auto; padding-top: var(--spacing-6); border-top: 1px solid var(--color-separator);">
        <a href="/employee" class="nav-item" style="background: rgba(255, 159, 10, 0.15); color: var(--color-orange);">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M9 5l7 7-7 7"/>
          </svg>
          <span id="backToEmployeeText">Back to Employee Portal</span>
        </a>
        <a href="#" onclick="stopImpersonation(); return false;" class="nav-item" id="stopImpersonationBtn" style="background: rgba(255, 69, 58, 0.15); color: var(--color-red); display: none;">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <span>Stop Viewing As</span>
        </a>
      </div>
      
      <div class="nav-section" style="margin-top: auto; padding-top: var(--spacing-6); border-top: 1px solid var(--color-separator);">
        <a href="#" onclick="handleLogout()" class="nav-item">
          <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
          <span>Sign Out</span>
        </a>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <div class="main-content">
    <!-- View As Banner (shown when admin/employee viewing as client) -->
    <div id="viewAsBanner" style="display: none; background: linear-gradient(135deg, #FF9F0A 0%, #FF6B35 100%); color: white; padding: var(--spacing-3) var(--spacing-4); margin-bottom: var(--spacing-4); border-radius: 0 0 12px 12px; box-shadow: 0 2px 8px rgba(255, 159, 10, 0.3); position: sticky; top: 0; z-index: 100;">
      <div style="display: flex; align-items: center; justify-content: space-between; max-width: 1400px; margin: 0 auto;">
        <div style="display: flex; align-items: center; gap: var(--spacing-3);">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="flex-shrink: 0;">
            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <div>
            <strong style="font-weight: 600; font-size: var(--font-body);">Viewing as Client</strong>
            <span style="margin: 0 var(--spacing-2); opacity: 0.9;">â€¢</span>
            <span style="font-size: var(--font-footnote); opacity: 0.9;" id="viewAsClientName">Client Dashboard</span>
          </div>
        </div>
        <a href="/employee" id="bannerBackToEmployee" style="display: inline-flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-2) var(--spacing-4); background: rgba(255, 255, 255, 0.2); color: white; border-radius: 8px; font-size: var(--font-footnote); font-weight: 600; text-decoration: none; transition: all 0.2s; border: 1px solid rgba(255, 255, 255, 0.3);" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='none'">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Employee Portal
        </a>
      </div>
    </div>
    
    <!-- Top Bar -->
    <header class="top-bar">
      <div>
        <h1 class="page-title">SEO Dashboard</h1>
        <p class="page-subtitle">Track performance and insights for www.berganco.com</p>
      </div>
      <div style="display: flex; align-items: center; gap: var(--spacing-3);">
        <!-- Back to Employee Portal button (shown when viewing as client) -->
        <a href="/employee" id="backToEmployeeBtn" style="display: none; padding: var(--spacing-2) var(--spacing-4); background: var(--color-orange); color: white; border-radius: 8px; font-size: var(--font-footnote); font-weight: 600; text-decoration: none; white-space: nowrap; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Employee Portal
        </a>
        <div class="date-filters">
          <button class="date-filter-btn active" onclick="setDateFilter(7)" id="filter-7">7 Days</button>
          <button class="date-filter-btn" onclick="setDateFilter(14)" id="filter-14">14 Days</button>
          <button class="date-filter-btn" onclick="setDateFilter(30)" id="filter-30">30 Days</button>
          <button class="date-filter-btn" onclick="setDateFilter(90)" id="filter-90">90 Days</button>
        </div>
        <button class="btn btn-primary" onclick="syncData()" id="syncButton" style="padding: var(--spacing-2) var(--spacing-4); font-size: var(--font-footnote); white-space: nowrap;">
          <span id="syncButtonText">Sync</span>
        </button>
      </div>
    </header>

    <!-- Content Area -->
    <main class="content-area">
    
    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard" class="hidden">
      
        <!-- Metric Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 mb-6">
        <!-- Clicks Card -->
          <div class="card metric-card">
            <div class="metric-header">
              <div class="metric-icon blue">
                <svg width="20" height="20" fill="none" stroke="#0A84FF" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                </svg>
            </div>
            </div>
            <div class="metric-label">Total Clicks</div>
            <div class="metric-value" id="totalClicks">-</div>
            <div class="metric-change" id="clicksChange">
              <span>No comparison data</span>
          </div>
        </div>

        <!-- Impressions Card -->
          <div class="card metric-card">
            <div class="metric-header">
              <div class="metric-icon purple">
                <svg width="20" height="20" fill="none" stroke="#AF52DE" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
            </div>
            </div>
            <div class="metric-label">Impressions</div>
            <div class="metric-value" id="totalImpressions">-</div>
            <div class="metric-change" id="impressionsChange">
              <span>No comparison data</span>
          </div>
        </div>

        <!-- CTR Card -->
          <div class="card metric-card">
            <div class="metric-header">
              <div class="metric-icon green">
                <svg width="20" height="20" fill="none" stroke="#30D158" stroke-width="2" viewBox="0 0 24 24">
                  <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
            </div>
            </div>
            <div class="metric-label">Avg CTR</div>
            <div class="metric-value" id="avgCtr">-</div>
            <div class="metric-change" id="ctrChange">
              <span>No comparison data</span>
          </div>
        </div>

        <!-- Position Card -->
          <div class="card metric-card">
            <div class="metric-header">
              <div class="metric-icon orange">
                <svg width="20" height="20" fill="none" stroke="#FF9F0A" stroke-width="2" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </div>
            </div>
            <div class="metric-label">Avg Position</div>
            <div class="metric-value" id="avgPosition">-</div>
            <div class="metric-change" id="positionChange">
              <span>No comparison data</span>
            </div>
          </div>
        </div>

        <!-- AI Insights Card -->
        <div class="card mb-6">
          <div class="section-header">
            <div>
              <h2 class="section-title">AI-Powered Insights</h2>
              <p class="section-subtitle">Market-aware analysis powered by Stuchai AI</p>
            </div>
            <button class="btn btn-ai-glow" onclick="loadAIInsights()" id="generateAI" style="padding: var(--spacing-3) var(--spacing-6); font-weight: 600;">Generate Insights</button>
          </div>
          <div id="aiInsights">
            <div style="padding: var(--spacing-8); text-align: center;">
              <p style="color: var(--color-label-tertiary); margin-bottom: var(--spacing-4);">
                Click "Generate Insights" to get AI-powered analysis for the selected time period.
              </p>
              <p style="font-size: var(--font-footnote); color: var(--color-label-tertiary);">
                This will analyze your SEO data with market context and provide actionable recommendations.
              </p>
            </div>
          </div>
        </div>

        <!-- AI Chat Assistant -->
        <div class="card mb-6">
          <div class="section-header">
            <div>
              <h2 class="section-title">Ask Stuchai AI</h2>
              <p class="section-subtitle">Ask follow-up questions about your SEO performance</p>
            </div>
          </div>
          <div id="aiChat" style="max-height: 400px; display: flex; flex-direction: column;">
            <!-- Chat Header -->
            <div style="padding: var(--spacing-3) var(--spacing-4); border-bottom: 1px solid var(--color-separator); display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: var(--font-footnote); color: var(--color-label-tertiary);">Chat with Stuchai AI</span>
              <button onclick="clearChat()" class="btn btn-secondary" style="padding: var(--spacing-1) var(--spacing-3); font-size: var(--font-footnote);">New Conversation</button>
            </div>
            <!-- Chat Messages -->
            <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: var(--spacing-4); min-height: 200px; max-height: 300px;">
              <div id="welcomeMessage" style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-radius: 12px; margin-bottom: var(--spacing-3); border: 1px solid var(--color-separator);">
                <p style="font-size: var(--font-footnote); color: var(--color-label-secondary); margin: 0;">
                  Try asking: "Why did my clicks drop?", "What should I focus on for the next week?", or "How can I improve my rankings?"
                </p>
              </div>
            </div>
            <!-- Chat Input -->
            <div style="padding: var(--spacing-4); border-top: 1px solid var(--color-separator); display: flex; gap: var(--spacing-2);">
              <input 
                type="text" 
                id="chatInput" 
                placeholder="Ask a question about your SEO data..."
                style="flex: 1; padding: var(--spacing-3); background: var(--color-bg-tertiary); border: 1px solid var(--color-separator); border-radius: 8px; color: var(--color-label-primary); font-size: var(--font-body); outline: none; transition: border-color 0.2s, box-shadow 0.2s;"
                onkeypress="if(event.key === 'Enter') sendChatMessage()"
                onfocus="this.style.borderColor = 'var(--color-blue)'; this.style.boxShadow = '0 0 0 3px rgba(10, 132, 255, 0.15)';"
                onblur="this.style.borderColor = 'var(--color-separator)'; this.style.boxShadow = 'none';"
              />
              <button class="btn btn-ai-glow" onclick="sendChatMessage()" id="sendChatBtn" style="padding: var(--spacing-3) var(--spacing-6); font-weight: 600;">Send</button>
            </div>
          </div>
      </div>

      <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 mb-6">
          <div class="card">
            <h2 class="section-title mb-4">Clicks & Impressions Trend</h2>
            <div class="chart-container">
          <canvas id="clicksChart"></canvas>
        </div>
        </div>
          <div class="card">
            <h2 class="section-title mb-4">CTR & Position Trend</h2>
            <div class="chart-container">
          <canvas id="ctrChart"></canvas>
        </div>
        </div>
      </div>

      <!-- Top Pages & Queries -->
        <div class="grid grid-cols-1 lg:grid-cols-2 mb-6">
          <div class="card">
            <h2 class="section-title mb-4">Top Pages</h2>
            <div id="topPages" style="max-height: 400px; overflow-y: auto;">
              <div class="loading">
                <div class="spinner"></div>
          </div>
        </div>
          </div>
          <div class="card">
            <h2 class="section-title mb-4">Top Search Queries</h2>
            <div id="topQueries" style="max-height: 400px; overflow-y: auto;">
              <div class="loading">
                <div class="spinner"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Competitive Analysis -->
        <div class="card mb-6">
          <div class="section-header">
            <div>
              <h2 class="section-title">Competitive Analysis</h2>
              <p class="section-subtitle">Denver Property Management Market Position</p>
            </div>
            <button class="btn btn-secondary" onclick="loadCompetitors()" id="refreshCompetitors">Refresh</button>
          </div>
          <div id="competitorAnalysis">
            <div class="loading">
              <div class="spinner"></div>
      </div>
          </div>
      </div>

      <!-- Latest Report Insights -->
        <div class="card">
          <h2 class="section-title mb-4">Latest Report Insights</h2>
          <div id="reportInsights">
            <p style="color: var(--color-label-tertiary);">No reports available yet. Generate your first report to see insights.</p>
        </div>
      </div>

    </div>
  </main>
    </div>

  <script>
    let clicksChart, ctrChart;
    let currentDays = 7;

    // Format numbers
    function formatNumber(num) {
      if (num === null || num === undefined || isNaN(num)) return '-';
      return num.toLocaleString('en-US');
    }

    // Format change
    function formatChange(change, inverted = false) {
      if (change === null || change === undefined || isNaN(change)) {
        return '<span>No comparison data</span>';
      }
      
      const isPositive = inverted ? change < 0 : change > 0;
      const className = isPositive ? 'positive' : 'negative';
      const arrow = isPositive ? 'â†‘' : 'â†“';
      const sign = isPositive && !inverted ? '+' : '';
      
      return `<span class="${className}">${arrow} ${sign}${Math.abs(change).toFixed(1)}${inverted ? '' : '%'}</span> <span style="color: var(--color-label-tertiary); font-size: 11px;">vs previous</span>`;
    }

    // Set date filter
    function setDateFilter(days) {
      currentDays = days;
      document.querySelectorAll('.date-filter-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`filter-${days}`).classList.add('active');
      loadDashboard();
    }

    // Sync data manually
    async function syncData() {
      const syncButton = document.getElementById('syncButton');
      const syncButtonText = document.getElementById('syncButtonText');
      
      if (!syncButton || !syncButtonText) return;
      
      try {
        syncButton.disabled = true;
        syncButtonText.textContent = 'Syncing...';
        syncButton.style.opacity = '0.6';
        
        // Pass current date range to sync missing days for that range
        const res = await fetch('/api/collect', { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ days: currentDays || 7 })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          if (data.syncing > 0) {
            syncButtonText.textContent = `Syncing ${data.syncing}...`;
            
            // Show progress message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--color-blue); color: white; padding: var(--spacing-3) var(--spacing-4); border-radius: 8px; font-size: var(--font-footnote); z-index: 1000; box-shadow: var(--shadow-md);';
            successMsg.textContent = `âœ“ Syncing ${data.syncing} missing day${data.syncing > 1 ? 's' : ''}... Please wait.`;
            document.body.appendChild(successMsg);
            
            // Calculate wait time based on number of days to sync (allow ~2 seconds per day)
            const waitTime = Math.max(5000, data.syncing * 2000);
            
            // Reload dashboard after sync completes (longer delay to allow background sync)
            setTimeout(() => {
              loadDashboard();
              successMsg.textContent = 'âœ“ Sync complete! Dashboard refreshed.';
              successMsg.style.background = 'var(--color-green)';
              setTimeout(() => successMsg.remove(), 3000);
            }, waitTime);
            
          } else {
            syncButtonText.textContent = 'All Synced';
            syncButton.style.opacity = '1';
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--color-green); color: white; padding: var(--spacing-3) var(--spacing-4); border-radius: 8px; font-size: var(--font-footnote); z-index: 1000; box-shadow: var(--shadow-md);';
            successMsg.textContent = 'âœ“ All data is already synced!';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
              successMsg.remove();
            }, 3000);
            
            // Still refresh to clear any warnings
            setTimeout(() => {
              loadDashboard();
            }, 1000);
          }
        } else {
          syncButtonText.textContent = 'Sync Failed';
          syncButton.style.opacity = '1';
          
          alert(`Failed to sync: ${data.error || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error syncing data:', error);
        syncButtonText.textContent = 'Sync Failed';
        syncButton.style.opacity = '1';
        alert('Failed to sync data. Please try again.');
      } finally {
        setTimeout(() => {
          syncButton.disabled = false;
          syncButtonText.textContent = 'Sync';
          syncButton.style.opacity = '1';
        }, 6000); // Longer timeout since sync may take time
      }
    }
    
    // Load dashboard
    async function loadDashboard() {
      const loadingEl = document.getElementById('loading');
      const dashboardEl = document.getElementById('dashboard');
      
      if (!loadingEl || !dashboardEl) {
        console.error('Dashboard elements not found:', { loadingEl, dashboardEl });
        return;
      }
      
      try {
        // Show loading, hide dashboard
        loadingEl.classList.remove('hidden');
        dashboardEl.classList.add('hidden');
        
        // Load main metrics first (show immediately)
        const response = await fetch(`/api/dashboard?days=${currentDays}`, { credentials: 'include' });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Dashboard API returned ${response.status}: ${errorText || response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Dashboard data received:', data);
        
        // Always show dashboard, even if metrics are missing
        loadingEl.classList.add('hidden');
        dashboardEl.classList.remove('hidden');
        
        if (data.metrics) {
          updateMetricCards(data.metrics, {
            dataCoverage: data.metrics.dataCoverage,
            missingDays: data.diagnostics?.missingDays || 0
          });
        } else {
          console.warn('No metrics data received');
          // Show placeholder values if no metrics
          document.getElementById('totalClicks').textContent = '-';
          document.getElementById('totalImpressions').textContent = '-';
          document.getElementById('avgCtr').textContent = '-';
          document.getElementById('avgPosition').textContent = '-';
        }
        
        if (data.latestReport) {
          updateReportInsights(data.latestReport);
        }

        // Load secondary content (charts, lists) in parallel after metrics are shown
        Promise.all([
          loadTrends(currentDays),
          loadTopPages(currentDays),
          loadTopQueries(currentDays),
          loadCompetitors()
        ]).catch(error => {
          console.error('Error loading secondary content:', error);
          // Don't block UI if secondary content fails
        });
      } catch (error) {
        console.error('Error loading dashboard:', error);
        const loadingEl = document.getElementById('loading');
        const dashboardEl = document.getElementById('dashboard');
        
        if (loadingEl) loadingEl.classList.add('hidden');
        if (dashboardEl) dashboardEl.classList.remove('hidden');
        
        // Show error message to user with helpful troubleshooting
        const errorMsg = document.createElement('div');
        errorMsg.id = 'dashboardError';
        errorMsg.style.cssText = 'padding: var(--spacing-4); background: rgba(255, 59, 48, 0.15); border: 1px solid var(--color-red); border-radius: 8px; margin-bottom: var(--spacing-4); color: var(--color-red);';
        
        let errorText = `Failed to load dashboard data: ${error instanceof Error ? error.message : 'Unknown error'}`;
        
        // Add helpful message for "Failed to fetch" errors (server not running)
        if (error instanceof TypeError && error.message.includes('fetch')) {
          errorText += '\n\nðŸ’¡ The server may not be running. To start the server:\n\n' +
            '1. Open terminal in the project directory\n' +
            '2. Run: npm run dev\n' +
            '3. Wait for "Server running on port 3000"\n' +
            '4. Refresh this page';
        }
        
        errorMsg.innerHTML = errorText.replace(/\n/g, '<br>').replace(/ðŸ’¡/g, 'ðŸ’¡');
        const dashboardDiv = document.getElementById('dashboard');
        if (dashboardDiv) {
          // Remove existing error if any
          const existingError = document.getElementById('dashboardError');
          if (existingError) {
            existingError.remove();
          }
          // Insert at the beginning of dashboard
          if (dashboardDiv.firstChild) {
            dashboardDiv.insertBefore(errorMsg, dashboardDiv.firstChild);
          } else {
            dashboardDiv.appendChild(errorMsg);
          }
        }
      }
    }

    // Update metric cards
    function updateMetricCards(metrics, diagnostics) {
      // Show data coverage warning if needed
      if (diagnostics && diagnostics.dataCoverage < 100) {
        const missingDays = diagnostics.missingDays || 0;
        if (missingDays > 0) {
          const warningMsg = `Missing data for ${missingDays} day${missingDays > 1 ? 's' : ''}. Numbers may be lower than Google Search Console. Click the "Sync" button above to sync missing days.

Note: Our dashboard excludes the last 3 days (Google's data delay), so "Last 7 days" here = 7 complete days ending 3 days ago. Google's "Last 7 days" includes today/yesterday which may have incomplete data.`;
          // Remove existing warning if any
          const existingWarning = document.getElementById('dataCoverageWarning');
          if (existingWarning) {
            existingWarning.remove();
          }
          
          // Show data coverage warning
          const warning = document.createElement('div');
          warning.id = 'dataCoverageWarning';
          warning.style.cssText = 'padding: var(--spacing-3) var(--spacing-4); background: rgba(255, 159, 10, 0.15); border: 1px solid var(--color-orange); border-radius: 8px; margin-bottom: var(--spacing-4); color: var(--color-orange); font-size: var(--font-footnote); display: flex; align-items: center; gap: var(--spacing-2);';
          warning.innerHTML = `
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <span>${warningMsg}</span>
          `;
          // Insert into dashboard div, before the metrics grid
          const dashboardDiv = document.getElementById('dashboard');
          const metricsGrid = dashboardDiv?.querySelector('.grid.grid-cols-4') || dashboardDiv?.querySelector('.grid');
          if (dashboardDiv && metricsGrid && metricsGrid.parentNode === dashboardDiv) {
            dashboardDiv.insertBefore(warning, metricsGrid);
          } else if (dashboardDiv && dashboardDiv.firstChild) {
            dashboardDiv.insertBefore(warning, dashboardDiv.firstChild);
          } else if (dashboardDiv) {
            dashboardDiv.appendChild(warning);
          }
        }
      } else {
        // Remove warning if data coverage is 100%
        const existingWarning = document.getElementById('dataCoverageWarning');
        if (existingWarning) {
          existingWarning.remove();
        }
      }
      document.getElementById('totalClicks').textContent = formatNumber(metrics.totalClicks);
      document.getElementById('clicksChange').innerHTML = formatChange(metrics.clicksChange);

      document.getElementById('totalImpressions').textContent = formatNumber(metrics.totalImpressions);
      document.getElementById('impressionsChange').innerHTML = formatChange(metrics.impressionsChange);

      const ctr = metrics.averageCtr ? (metrics.averageCtr * 100).toFixed(2) + '%' : '-';
      document.getElementById('avgCtr').textContent = ctr;
      document.getElementById('ctrChange').innerHTML = formatChange(metrics.ctrChange);

      const position = metrics.averagePosition ? metrics.averagePosition.toFixed(1) : '-';
      document.getElementById('avgPosition').textContent = position;
      document.getElementById('positionChange').innerHTML = formatChange(metrics.positionChange, true);
    }

    // Load trends
    async function loadTrends(days) {
      try {
        const response = await fetch(`/api/trends?days=${days}`);
        const data = await response.json();

        if (!data || data.length === 0) return;

        // Format dates - responsive formatting
        const isMobile = window.innerWidth < 768;
        const dates = data.map(d => {
          const date = new Date(d.date);
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        const clicks = data.map(d => d.clicks);
        const impressions = data.map(d => d.impressions);
        const ctrs = data.map(d => d.ctr * 100);
        const positions = data.map(d => d.position);

        // Clicks Chart
        const clicksCtx = document.getElementById('clicksChart');
        if (!clicksCtx) return;
        const clicksCtx2d = clicksCtx.getContext('2d');
        if (clicksChart) clicksChart.destroy();
        clicksChart = new Chart(clicksCtx2d, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [
              {
                label: 'Clicks',
                data: clicks,
                borderColor: '#0A84FF',
                backgroundColor: 'rgba(10, 132, 255, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2
              },
              {
                label: 'Impressions',
                data: impressions,
                borderColor: '#AF52DE',
                backgroundColor: 'rgba(175, 82, 222, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { 
                  color: '#E5E5EA', 
                  font: { 
                    family: '-apple-system', 
                    size: isMobile ? 10 : 12 
                  },
                  boxWidth: isMobile ? 10 : 12,
                  padding: isMobile ? 8 : 10
                },
                position: 'top',
                align: 'center'
              }
            },
            scales: {
              x: { 
                grid: { color: '#48484A', display: true }, 
                ticks: { 
                  color: '#98989D',
                  font: { size: isMobile ? 10 : 12 },
                  maxRotation: isMobile ? 45 : 0,
                  autoSkip: true,
                  maxTicksLimit: isMobile ? 6 : 10,
                  padding: isMobile ? 4 : 8
                },
                title: {
                  display: false
                }
              },
              y: { 
                grid: { color: '#48484A', display: true }, 
                ticks: { 
                  color: '#98989D',
                  font: { size: isMobile ? 10 : 12 },
                  maxTicksLimit: isMobile ? 5 : 8,
                  padding: isMobile ? 4 : 8
                }, 
                beginAtZero: true,
                title: {
                  display: false
                }
              },
              y1: { 
                grid: { drawOnChartArea: false, display: false }, 
                ticks: { 
                  color: '#98989D',
                  font: { size: isMobile ? 10 : 12 },
                  maxTicksLimit: isMobile ? 5 : 8,
                  padding: isMobile ? 4 : 8
                }, 
                position: 'right', 
                beginAtZero: true,
                title: {
                  display: false
                }
              }
            },
            layout: {
              padding: {
                top: isMobile ? 5 : 10,
                bottom: isMobile ? 5 : 10,
                left: isMobile ? 5 : 10,
                right: isMobile ? 5 : 10
              }
            }
          }
        });

        // CTR Chart
        const ctrCtx = document.getElementById('ctrChart');
        if (!ctrCtx) return;
        const ctrCtx2d = ctrCtx.getContext('2d');
        if (ctrChart) ctrChart.destroy();
        ctrChart = new Chart(ctrCtx2d, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [
              {
                label: 'CTR (%)',
                data: ctrs,
                borderColor: '#30D158',
                backgroundColor: 'rgba(48, 209, 88, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2
              },
              {
                label: 'Position',
                data: positions,
                borderColor: '#FF9F0A',
                backgroundColor: 'rgba(255, 159, 10, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { 
                  color: '#E5E5EA', 
                  font: { 
                    family: '-apple-system', 
                    size: isMobile ? 10 : 12 
                  },
                  boxWidth: isMobile ? 10 : 12,
                  padding: isMobile ? 8 : 10
                },
                position: 'top',
                align: 'center'
              }
            },
            scales: {
              x: { 
                grid: { color: '#48484A', display: true }, 
                ticks: { 
                  color: '#98989D',
                  font: { size: isMobile ? 10 : 12 },
                  maxRotation: isMobile ? 45 : 0,
                  autoSkip: true,
                  maxTicksLimit: isMobile ? 6 : 10,
                  padding: isMobile ? 4 : 8
                },
                title: {
                  display: false
                }
              },
              y: { 
                grid: { color: '#48484A', display: true }, 
                ticks: { 
                  color: '#98989D',
                  font: { size: isMobile ? 10 : 12 },
                  maxTicksLimit: isMobile ? 5 : 8,
                  padding: isMobile ? 4 : 8
                }, 
                beginAtZero: true,
                title: {
                  display: false
                }
              },
              y1: { 
                grid: { drawOnChartArea: false, display: false }, 
                ticks: { 
                  color: '#98989D',
                  font: { size: isMobile ? 10 : 12 },
                  maxTicksLimit: isMobile ? 5 : 8,
                  padding: isMobile ? 4 : 8
                }, 
                reverse: true, 
                position: 'right', 
                beginAtZero: true,
                title: {
                  display: false
                }
              }
            },
            layout: {
              padding: {
                top: isMobile ? 5 : 10,
                bottom: isMobile ? 5 : 10,
                left: isMobile ? 5 : 10,
                right: isMobile ? 5 : 10
              }
            }
          }
        });
      } catch (error) {
        console.error('Error loading trends:', error);
      }
    }

    // Load top pages
    async function loadTopPages(days) {
      try {
        const response = await fetch(`/api/top-pages?days=${days}&limit=10`);
        const data = await response.json();

        if (!data || data.length === 0) {
          document.getElementById('topPages').innerHTML = '<p style="color: var(--color-label-tertiary); text-align: center; padding: var(--spacing-8) 0;">No page data available</p>';
          return;
        }

        const html = data.map(page => {
          const url = page.page.replace('https://www.berganco.com', '') || '/';
          return `
            <div style="padding: var(--spacing-3) 0; border-bottom: 1px solid var(--color-separator);">
              <div style="font-size: var(--font-body); font-weight: 500; color: var(--color-label-primary); margin-bottom: var(--spacing-1);">${url}</div>
              <div style="font-size: var(--font-caption); color: var(--color-label-tertiary);">
                ${formatNumber(page._sum.clicks)} clicks Â· ${((page._avg.ctr || 0) * 100).toFixed(2)}% CTR Â· ${formatNumber(page._sum.impressions)} impressions
              </div>
            </div>
          `;
        }).join('');

        document.getElementById('topPages').innerHTML = html;
      } catch (error) {
        console.error('Error loading pages:', error);
      }
    }

    // Load top queries
    async function loadTopQueries(days) {
      try {
        const response = await fetch(`/api/top-queries?days=${days}&limit=10`);
        const data = await response.json();

        if (!data || data.length === 0) {
          document.getElementById('topQueries').innerHTML = '<p style="color: var(--color-label-tertiary); text-align: center; padding: var(--spacing-8) 0;">No query data available</p>';
          return;
        }

        const html = data.map(query => {
          return `
            <div style="padding: var(--spacing-3) 0; border-bottom: 1px solid var(--color-separator);">
              <div style="font-size: var(--font-body); font-weight: 500; color: var(--color-label-primary); margin-bottom: var(--spacing-1);">"${query.query}"</div>
              <div style="font-size: var(--font-caption); color: var(--color-label-tertiary);">
                ${formatNumber(query._sum.clicks)} clicks Â· ${((query._avg.ctr || 0) * 100).toFixed(2)}% CTR Â· Position ${(query._avg.position || 0).toFixed(1)}
              </div>
            </div>
          `;
        }).join('');

        document.getElementById('topQueries').innerHTML = html;
      } catch (error) {
        console.error('Error loading queries:', error);
      }
    }

    // Load AI insights
    async function loadAIInsights() {
      try {
        const button = document.getElementById('generateAI');
        if (button) {
          button.disabled = true;
          button.textContent = 'Generating...';
        }

        // Show loading state
        document.getElementById('aiInsights').innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <p style="color: var(--color-label-secondary); margin-top: var(--spacing-3);">Analyzing your SEO data with Stuchai AI...</p>
          </div>
        `;

        const response = await fetch(`/api/ai-insights?days=${currentDays}`);
        const data = await response.json();

        if (data.insight) {
          document.getElementById('aiInsights').innerHTML = `
            <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border: 1px solid var(--color-separator); border-radius: 12px;">
              <p style="font-size: var(--font-body); color: var(--color-label-primary); line-height: 1.6; margin: 0;">${data.insight}</p>
              <p style="font-size: var(--font-caption); color: var(--color-label-tertiary); margin-top: var(--spacing-2);">
                Generated ${new Date(data.generatedAt).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}
              </p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading AI insights:', error);
      } finally {
        const button = document.getElementById('generateAI');
        if (button) {
          button.disabled = false;
          button.textContent = 'Generate Insights';
        }
      }
    }

    // Send chat message
    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;

      const sendBtn = document.getElementById('sendChatBtn');
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';
      input.disabled = true;

      // Add user message to chat
      addChatMessage('user', message);
      chatMessages.push({ role: 'user', content: message });
      input.value = '';

      // Add loading message
      const loadingId = addChatMessage('assistant', 'Thinking...', true);

      try {
        // Get comprehensive dashboard data for context
        const [dashboardResponse, pagesResponse, queriesResponse] = await Promise.all([
          fetch(`/api/dashboard?days=${currentDays}`),
          fetch(`/api/top-pages?days=${currentDays}&limit=10`),
          fetch(`/api/top-queries?days=${currentDays}&limit=10`)
        ]);
        
        const dashboardData = await dashboardResponse.json();
        const pagesData = await pagesResponse.json();
        const queriesData = await queriesResponse.json();

        const response = await fetch('/api/ai-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            context: {
              days: currentDays,
              metrics: dashboardData.metrics,
              topPages: pagesData.slice(0, 10) || [],
              topQueries: queriesData.slice(0, 10) || [],
              dailyMetrics: dashboardData.latestMetrics || [],
            }
          })
        });

        const data = await response.json();
        
        // Remove loading message and add AI response
        removeChatMessage(loadingId);
        const aiResponse = data.response || 'I apologize, but I encountered an error. Please try again.';
        addChatMessage('assistant', aiResponse);
        chatMessages.push({ role: 'assistant', content: aiResponse });
      } catch (error) {
        console.error('Error sending chat message:', error);
        removeChatMessage(loadingId);
        addChatMessage('assistant', 'Sorry, I encountered an error. Please try again.');
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
        input.disabled = false;
        input.focus();
      }
    }

    // Add message to chat
    function addChatMessage(role, message, isLoading = false) {
      const messagesDiv = document.getElementById('chatMessages');
      const messageId = 'msg-' + Date.now();
      
      const isUser = role === 'user';
      const alignStyle = isUser ? 'margin-left: 20%;' : 'margin-right: 20%;';
      const bgColor = isUser ? 'var(--color-blue)' : 'var(--color-bg-tertiary)';
      const textColor = isUser ? 'white' : 'var(--color-label-primary)';

      const messageDiv = document.createElement('div');
      messageDiv.id = messageId;
      messageDiv.style.cssText = `${alignStyle} margin-bottom: var(--spacing-3);`;
      
      // Format AI messages with better styling
      let formattedMessage = message;
      if (!isUser && !isLoading) {
        // Format markdown-style lists and sections
        formattedMessage = formatAIResponse(message);
      }
      
      messageDiv.innerHTML = `
        <div style="padding: var(--spacing-3) var(--spacing-4); background: ${bgColor}; border-radius: 12px; display: inline-block; max-width: 100%; border: ${isUser ? 'none' : '0.5px solid var(--color-separator)'};">
          ${isUser ? 
            `<p style="font-size: var(--font-body); color: ${textColor}; margin: 0; line-height: 1.6; white-space: pre-wrap;">${message}</p>` :
            `<div style="font-size: var(--font-body); color: ${textColor}; line-height: 1.6;">${formattedMessage}</div>`
          }
          ${isLoading ? '<div class="spinner" style="width: 16px; height: 16px; margin-top: var(--spacing-2);"></div>' : ''}
        </div>
      `;

      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      return messageId;
    }
    
    // Format AI response for better readability
    function formatAIResponse(text) {
      // Split by double newlines to create paragraphs
      let formatted = text
        // Format numbered lists (1. 2. 3.)
        .replace(/^(\d+\.\s+)(.+)$/gm, '<div style="margin: var(--spacing-2) 0; padding-left: var(--spacing-4);"><strong style="color: var(--color-blue);">$1</strong>$2</div>')
        // Format bullet points (- or â€¢)
        .replace(/^[-â€¢]\s+(.+)$/gm, '<div style="margin: var(--spacing-2) 0; padding-left: var(--spacing-4); display: flex; align-items: flex-start;"><span style="color: var(--color-blue); margin-right: var(--spacing-2); margin-top: 6px;">â€¢</span><span>$1</span></div>')
        // Format **bold** text
        .replace(/\*\*(.+?)\*\*/g, '<strong style="color: var(--color-label-primary); font-weight: 600;">$1</strong>')
        // Format paragraphs
        .split('\n\n')
        .map(para => {
          if (para.trim() && !para.includes('<div')) {
            return `<p style="margin: var(--spacing-3) 0; line-height: 1.7;">${para.trim()}</p>`;
          }
          return para;
        })
        .join('');
      
      return formatted;
    }

    // Remove message from chat
    function removeChatMessage(messageId) {
      const msg = document.getElementById(messageId);
      if (msg) msg.remove();
    }

    // Clear chat conversation
    function clearChat() {
      const messagesDiv = document.getElementById('chatMessages');
      messagesDiv.innerHTML = `
        <div id="welcomeMessage" style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-radius: 12px; margin-bottom: var(--spacing-3); border: 1px solid var(--color-separator);">
          <p style="font-size: var(--font-footnote); color: var(--color-label-secondary); margin: 0;">
            Try asking: "Why did my clicks drop?", "What should I focus on for the next week?", or "How can I improve my rankings?"
          </p>
        </div>
      `;
      chatMessages = [];
    }

    let chatMessages = [];

    // Update sidebar branding
    function updateSidebarBranding(user) {
      const brandIcon = document.getElementById('sidebarBrandIcon');
      const brandText = document.getElementById('sidebarBrandText');
      const brandTagline = document.getElementById('sidebarTagline');
      
      if (user.logoUrl) {
        brandIcon.innerHTML = `<img src="${user.logoUrl}" alt="${user.businessName || 'Company'}" style="width: 32px; height: 32px; border-radius: 8px; object-fit: cover;">`;
      } else {
        const initial = (user.businessName || 'B')[0].toUpperCase();
        brandIcon.textContent = initial;
      }
      
      // Always use business name, fall back to default
      if (user.businessName) {
        brandText.textContent = user.businessName;
        brandTagline.textContent = `${user.businessName} SEO Analytics`;
      } else {
        brandText.textContent = 'BerganCo';
        brandTagline.textContent = 'SEO Analytics';
      }
    }

    // Load competitive analysis
    async function loadCompetitors() {
      try {
        const button = document.getElementById('refreshCompetitors');
        if (button) {
          button.disabled = true;
          button.textContent = 'Refreshing...';
        }

        const response = await fetch('/api/competitors');
        const data = await response.json();

        if (data.topCompetitors && data.topCompetitors.length > 0) {
          // Rank competitors
          const rankedCompetitors = data.topCompetitors.map((comp, idx) => {
            const position = idx + 1;
            return { ...comp, position };
          });

          const html = `
            <div style="margin-bottom: var(--spacing-6);">
              <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-radius: 12px; margin-bottom: var(--spacing-4);">
                <h3 style="font-size: var(--font-title-3); font-weight: 600; color: var(--color-label-primary); margin-bottom: var(--spacing-2);">
                  Market Position: ${data.summary.split('.')[0]}
                </h3>
                <p style="font-size: var(--font-body); color: var(--color-label-secondary); line-height: 1.6; margin: 0;">
                  ${data.summary}
                </p>
              </div>

              <div style="margin-bottom: var(--spacing-6);">
                <h3 style="font-size: var(--font-title-3); font-weight: 600; color: var(--color-label-primary); margin-bottom: var(--spacing-4);">
                  Competitor Rankings
                </h3>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-3);">
                  ${rankedCompetitors.map(comp => `
                    <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border: 1px solid var(--color-separator); border-radius: 12px;">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-3);">
                        <div style="flex: 1;">
                          <div style="display: flex; align-items: center; gap: var(--spacing-3); margin-bottom: var(--spacing-2);">
                            <div style="width: 32px; height: 32px; border-radius: 16px; background: ${comp.position <= 3 ? 'var(--color-blue)' : 'var(--color-bg-secondary)'}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                              <span style="font-size: var(--font-footnote); font-weight: 700; color: ${comp.position <= 3 ? 'white' : 'var(--color-label-secondary)'};">
                                ${comp.position}
                              </span>
                            </div>
                            <div style="flex: 1;">
                              <div style="font-size: var(--font-body); font-weight: 600; color: var(--color-label-primary);">${comp.name}</div>
                              <div style="font-size: var(--font-footnote); color: var(--color-label-tertiary); margin-top: var(--spacing-1);">${comp.domain}</div>
                            </div>
                          </div>
                          <div style="display: flex; flex-direction: column; gap: var(--spacing-2); margin-top: var(--spacing-3);">
                            <div style="font-size: var(--font-caption); font-weight: 600; color: var(--color-label-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--spacing-1);">
                              What They Do Well:
                            </div>
                            ${comp.strengths.map(strength => `
                              <div style="display: flex; align-items: start; gap: var(--spacing-2);">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0; margin-top: 2px;">
                                  <circle cx="8" cy="8" r="7" stroke="#30D158" stroke-width="1.5"/>
                                  <path d="M5 8l2 2 4-4" stroke="#30D158" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span style="font-size: var(--font-footnote); color: var(--color-label-secondary); line-height: 1.5;">${strength}</span>
                              </div>
                            `).join('')}
                          </div>
                        </div>
                        <div style="text-align: right; margin-left: var(--spacing-4);">
                          <div style="font-size: var(--font-footnote); color: var(--color-label-tertiary); margin-bottom: var(--spacing-1);">
                            Est. Traffic
                          </div>
                          <div style="font-size: var(--font-body); font-weight: 600; color: var(--color-label-primary);">
                            ${comp.estimatedTraffic ? formatNumber(comp.estimatedTraffic) : 'N/A'}
                          </div>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
                <div>
                  <h3 style="font-size: var(--font-title-3); font-weight: 600; color: var(--color-label-primary); margin-bottom: var(--spacing-3);">
                    BerganCo Advantages
                  </h3>
                  <div style="display: flex; flex-direction: column; gap: var(--spacing-2);">
                    ${data.bergancoAdvantages.map(adv => `
                      <div style="padding: var(--spacing-3); background: rgba(48, 209, 88, 0.1); border-left: 3px solid var(--color-green); border-radius: 8px;">
                        <span style="font-size: var(--font-footnote); color: var(--color-label-primary);">${adv}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
                <div>
                  <h3 style="font-size: var(--font-title-3); font-weight: 600; color: var(--color-label-primary); margin-bottom: var(--spacing-3);">
                    Areas to Improve
                  </h3>
                  <div style="display: flex; flex-direction: column; gap: var(--spacing-2);">
                    ${data.competitorAdvantages.map(area => `
                      <div style="padding: var(--spacing-3); background: rgba(255, 69, 58, 0.1); border-left: 3px solid var(--color-red); border-radius: 8px;">
                        <span style="font-size: var(--font-footnote); color: var(--color-label-primary);">${area}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
            </div>
          `;

          document.getElementById('competitorAnalysis').innerHTML = html;
        } else {
          document.getElementById('competitorAnalysis').innerHTML = `
            <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border: 1px solid var(--color-separator); border-radius: 12px;">
              <p style="color: var(--color-label-tertiary); text-align: center;">Unable to load competitive analysis data.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading competitors:', error);
        document.getElementById('competitorAnalysis').innerHTML = `
          <div style="padding: var(--spacing-4); background: rgba(255, 69, 58, 0.1); border: 1px solid var(--color-red); border-radius: 12px;">
            <p style="color: var(--color-red); text-align: center;">Error loading competitive analysis. Please try again.</p>
          </div>
        `;
      } finally {
        const button = document.getElementById('refreshCompetitors');
        if (button) {
          button.disabled = false;
          button.textContent = 'Refresh';
        }
      }
    }

    // Update report insights
    function updateReportInsights(report) {
      const insights = report.insights ? report.insights.split('\n').join('<br>') : 'No insights available.';
      const recommendations = report.recommendations ? report.recommendations.split('\n').join('<br>') : '';

      document.getElementById('reportInsights').innerHTML = `
        <div style="margin-bottom: var(--spacing-6);">
          <h3 style="font-size: var(--font-title-3); font-weight: 600; color: var(--color-label-primary); margin-bottom: var(--spacing-3);">Insights</h3>
          <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-left: 3px solid #FF9F0A; border-radius: 12px;">
            <p style="font-size: var(--font-body); color: var(--color-label-primary); line-height: 1.6; margin: 0;">${insights}</p>
          </div>
        </div>
        ${recommendations ? `
        <div>
          <h3 style="font-size: var(--font-title-3); font-weight: 600; color: var(--color-label-primary); margin-bottom: var(--spacing-3);">Recommendations</h3>
          <div style="padding: var(--spacing-4); background: var(--color-bg-tertiary); border-left: 3px solid #0A84FF; border-radius: 12px;">
            <p style="font-size: var(--font-body); color: var(--color-label-primary); line-height: 1.6; margin: 0;">${recommendations}</p>
          </div>
        </div>
        ` : ''}
      `;
    }

    // Check authentication and load dashboard
    async function init() {
      try {
        const response = await fetch('/api/auth/me', { credentials: 'include' });
        if (response.ok) {
          const data = await response.json();
          if (data.user) {
            // Handle admin/employee viewing client dashboard
            const originalAdminToken = getCookie('originalAdminToken');
            const userRole = data.user.role;
            
            // If admin/employee is viewing client dashboard, show "Back to Employee Portal" button
            // Don't redirect automatically - allow them to view client dashboard
            if ((userRole === 'ADMIN' || userRole === 'EMPLOYEE') && !originalAdminToken) {
              console.log('Admin/Employee viewing client dashboard - showing banner');
              // Show prominent banner at top
              const viewAsBanner = document.getElementById('viewAsBanner');
              const clientNameSpan = document.getElementById('viewAsClientName');
              if (viewAsBanner) {
                viewAsBanner.style.display = 'block';
                console.log('Banner shown for admin/employee view');
                if (clientNameSpan) {
                  clientNameSpan.textContent = data.user.businessName || data.user.name || 'Client Dashboard';
                }
              } else {
                console.error('Banner element not found!');
              }
              // Update banner link
              const bannerBackLink = document.getElementById('bannerBackToEmployee');
              if (bannerBackLink) {
                bannerBackLink.href = '/employee';
                bannerBackLink.onclick = null;
              }
              // Show prominent back button in top bar
              const backToEmployeeBtn = document.getElementById('backToEmployeeBtn');
              if (backToEmployeeBtn) {
                backToEmployeeBtn.style.display = 'inline-flex';
                backToEmployeeBtn.style.alignItems = 'center';
              }
              // Show admin section with "Back to Employee Portal" button
              const adminNavSection = document.getElementById('adminNavSection');
              if (adminNavSection) {
                adminNavSection.style.display = 'block';
              }
              // Also show a prominent back button in the impersonation section
              const impersonationSection = document.getElementById('impersonationSection');
              if (impersonationSection) {
                impersonationSection.style.display = 'block';
                // Change the text to indicate they can go back
                const backLink = impersonationSection.querySelector('a[href="/employee"]');
                if (backLink) {
                  backLink.querySelector('span').textContent = 'Back to Employee Portal';
                }
              }
            }
            
            // Update sidebar branding
            try {
              updateSidebarBranding(data.user);
            } catch (e) {
              console.error('Error updating sidebar:', e);
            }
            
            // Check if impersonating or admin viewing client dashboard
            try {
              const impersonationSection = document.getElementById('impersonationSection');
              const stopImpersonationBtn = document.getElementById('stopImpersonationBtn');
              
              if (originalAdminToken && data.user.role === 'CLIENT') {
                // Actually impersonating a client - show banner
                console.log('Impersonating client - showing banner');
                const viewAsBanner = document.getElementById('viewAsBanner');
                const clientNameSpan = document.getElementById('viewAsClientName');
                if (viewAsBanner) {
                  viewAsBanner.style.display = 'block';
                  console.log('Banner shown');
                  if (clientNameSpan) {
                    clientNameSpan.textContent = data.user.businessName || data.user.name || 'Client Dashboard';
                  }
                } else {
                  console.error('Banner element not found!');
                }
                // Update banner link to stop impersonation
                const bannerBackLink = document.getElementById('bannerBackToEmployee');
                if (bannerBackLink) {
                  bannerBackLink.onclick = async (e) => {
                    e.preventDefault();
                    await stopImpersonation();
                  };
                }
                // Show top bar button
                const backToEmployeeBtn = document.getElementById('backToEmployeeBtn');
                if (backToEmployeeBtn) {
                  backToEmployeeBtn.style.display = 'inline-flex';
                  backToEmployeeBtn.style.alignItems = 'center';
                  // Update to stop impersonation, then redirect
                  backToEmployeeBtn.onclick = async (e) => {
                    e.preventDefault();
                    await stopImpersonation();
                  };
                }
                // Update sidebar link to also stop impersonation
                const sidebarBackLink = document.getElementById('sidebarBackToEmployee');
                if (sidebarBackLink) {
                  sidebarBackLink.onclick = async (e) => {
                    e.preventDefault();
                    await stopImpersonation();
                  };
                }
                if (impersonationSection) {
                  impersonationSection.style.display = 'block';
                  if (stopImpersonationBtn) {
                    stopImpersonationBtn.style.display = 'block';
                  }
                }
              } else if ((data.user.role === 'ADMIN' || data.user.role === 'EMPLOYEE')) {
                // Admin/employee viewing client dashboard (not impersonating, just viewing)
                // Show banner
                console.log('Admin/Employee viewing client dashboard (role check) - showing banner');
                const viewAsBanner = document.getElementById('viewAsBanner');
                const clientNameSpan = document.getElementById('viewAsClientName');
                if (viewAsBanner) {
                  viewAsBanner.style.display = 'block';
                  console.log('Banner shown for admin/employee (role check)');
                  if (clientNameSpan) {
                    clientNameSpan.textContent = data.user.businessName || data.user.name || 'Client Dashboard';
                  }
                } else {
                  console.error('Banner element not found!');
                }
                // Update banner link
                const bannerBackLink = document.getElementById('bannerBackToEmployee');
                if (bannerBackLink) {
                  bannerBackLink.href = '/employee';
                  bannerBackLink.onclick = null;
                }
                // Show top bar button with direct link
                const backToEmployeeBtn = document.getElementById('backToEmployeeBtn');
                if (backToEmployeeBtn) {
                  backToEmployeeBtn.style.display = 'inline-flex';
                  backToEmployeeBtn.style.alignItems = 'center';
                  backToEmployeeBtn.onclick = null; // Remove any click handler
                  backToEmployeeBtn.href = '/employee'; // Direct link
                }
                // Sidebar link can go directly
                const sidebarBackLink = document.getElementById('sidebarBackToEmployee');
                if (sidebarBackLink) {
                  sidebarBackLink.onclick = null;
                  sidebarBackLink.href = '/employee';
                }
                if (impersonationSection) {
                  impersonationSection.style.display = 'block';
                  if (stopImpersonationBtn) {
                    stopImpersonationBtn.style.display = 'none'; // Hide stop button, just show back button
                  }
                  const backText = document.getElementById('backToEmployeeText');
                  if (backText) {
                    backText.textContent = 'Back to Employee Portal';
                  }
                }
              }
              
              // Show admin section if employee/admin
              if (data.user.role !== 'CLIENT') {
                const adminNavSection = document.getElementById('adminNavSection');
                if (adminNavSection) {
                  adminNavSection.style.display = 'block';
                }
              }
            } catch (e) {
              console.error('Error updating navigation:', e);
            }
            
            // Load dashboard after auth check passes
            loadDashboard();
          } else {
            // Redirect to login if not authenticated
            window.location.href = '/login';
            return;
          }
        } else {
          window.location.href = '/login';
          return;
        }
      } catch (error) {
        console.error('Auth error:', error);
        // Show dashboard anyway, let loadDashboard handle errors
        const loadingEl = document.getElementById('loading');
        const dashboardEl = document.getElementById('dashboard');
        if (loadingEl) loadingEl.classList.add('hidden');
        if (dashboardEl) dashboardEl.classList.remove('hidden');
        
        // Try to load dashboard even if auth check failed (might be CORS or network issue)
        try {
          loadDashboard();
        } catch (e) {
          console.error('Failed to load dashboard:', e);
        }
      }
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    async function stopImpersonation() {
      const res = await fetch('/api/auth/stop-impersonate', {
        method: 'POST',
        credentials: 'include'
      });
      
      if (res.ok) {
        const data = await res.json();
        // Update session token and redirect
        window.location.href = '/employee';
        } else {
        const error = await res.json();
        alert(`Failed to stop impersonation: ${error.error || 'Unknown error'}`);
      }
    }
    
    async function handleLogout() {
      try {
        await fetch('/api/auth/logout', { 
          method: 'POST',
          credentials: 'include'
        });
        window.location.href = '/login.html';
      } catch (error) {
        window.location.href = '/login.html';
      }
    }
    
    // Initialize on page load with safety timeout
    function startInit() {
      // Safety timeout: if dashboard hasn't loaded in 10 seconds, show it anyway
      setTimeout(() => {
        const loadingEl = document.getElementById('loading');
        const dashboardEl = document.getElementById('dashboard');
        if (loadingEl && dashboardEl && dashboardEl.classList.contains('hidden')) {
          console.warn('Dashboard loading timeout - forcing display');
          loadingEl.classList.add('hidden');
          dashboardEl.classList.remove('hidden');
        }
      }, 10000);
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        // DOM already loaded
        init();
      }
    }
    
    startInit();
  </script>

</body>
</html>