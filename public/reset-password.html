<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password - BerganCo SEO</title>
  <link rel="icon" type="image/png" href="https://framerusercontent.com/images/AhyGPdkv1Kr9JeLtiQvJBU0uJE.png?scale-down-to=1024&width=2088&height=518">
  <style>
    /* StuchAI Brand Guidelines - Apple Design System */
    :root {
      --color-bg-primary: #1C1C1E;
      --color-bg-secondary: #2C2C2E;
      --color-bg-tertiary: #3A3A3C;
      --color-label-primary: #FFFFFF;
      --color-label-secondary: #E5E5EA;
      --color-label-tertiary: #98989D;
      --color-separator: #48484A;
      --color-blue: #0A84FF;
      --color-green: #30D158;
      --color-red: #FF453A;
      
      --spacing-2: 8px;
      --spacing-3: 12px;
      --spacing-4: 16px;
      --spacing-6: 24px;
      --font-body: 17px;
      --font-footnote: 13px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
      background: var(--color-bg-primary);
      color: var(--color-label-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: var(--spacing-4);
    }
    
    .reset-container {
      width: 100%;
      max-width: 400px;
    }
    
    /* Logo Section */
    .reset-logo {
      text-align: center;
      margin-bottom: var(--spacing-6);
    }
    
    .logo-image {
      max-width: 100%;
      height: auto;
      max-height: 120px;
      margin-bottom: var(--spacing-4);
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    
    /* Title */
    .reset-title {
      font-size: 34px;
      font-weight: 700;
      color: var(--color-label-primary);
      margin-bottom: var(--spacing-4);
      text-align: center;
    }
    
    /* Success/Error Message */
    .reset-message {
      display: none;
      padding: var(--spacing-3) var(--spacing-4);
      border-radius: 12px;
      font-size: var(--font-footnote);
      margin-bottom: var(--spacing-4);
      align-items: center;
      gap: var(--spacing-2);
    }
    
    .reset-message.show {
      display: flex;
    }
    
    .reset-message.success {
      background: rgba(48, 209, 88, 0.15);
      border: 0.5px solid rgba(48, 209, 88, 0.3);
      color: var(--color-green);
    }
    
    .reset-message.error {
      background: rgba(255, 69, 58, 0.15);
      border: 0.5px solid rgba(255, 69, 58, 0.3);
      color: var(--color-red);
    }
    
    .reset-message svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }
    
    /* Form */
    form {
      margin-top: var(--spacing-6);
    }
    
    .form-group {
      margin-bottom: var(--spacing-4);
    }
    
    .form-group label {
      display: block;
      font-size: var(--font-footnote);
      font-weight: 500;
      color: var(--color-label-secondary);
      margin-bottom: var(--spacing-2);
    }
    
    .form-input {
      width: 100%;
      padding: var(--spacing-3) var(--spacing-4);
      background: var(--color-bg-tertiary);
      border: 0.5px solid var(--color-separator);
      border-radius: 12px;
      color: var(--color-label-primary);
      font-size: var(--font-body);
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .form-input:focus {
      border-color: var(--color-blue);
      box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.15);
    }
    
    .form-input::placeholder {
      color: var(--color-label-tertiary);
    }
    
    /* Button */
    .btn-primary {
      width: 100%;
      padding: var(--spacing-3) var(--spacing-4);
      background: var(--color-blue);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: var(--font-body);
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s;
      position: relative;
    }
    
    .btn-primary:hover:not(:disabled) {
      opacity: 0.85;
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary .spinner {
      display: none;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin: 0 auto;
    }
    
    .btn-primary.loading .spinner {
      display: block;
    }
    
    .btn-primary.loading .btn-text {
      display: none;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Back to Login Link */
    .reset-back {
      text-align: center;
      margin-top: var(--spacing-4);
      padding-top: var(--spacing-4);
      border-top: 0.5px solid var(--color-separator);
    }
    
    .reset-back p {
      font-size: var(--font-footnote);
      color: var(--color-label-tertiary);
    }
    
    .reset-back a {
      color: var(--color-blue);
      text-decoration: none;
      font-weight: 500;
    }
    
    .reset-back a:hover {
      opacity: 0.7;
    }

    /* Step Indicator */
    .step-indicator {
      text-align: center;
      margin-bottom: var(--spacing-4);
      font-size: var(--font-footnote);
      color: var(--color-label-tertiary);
    }
  </style>
</head>
<body>
  <div class="reset-container">
    <!-- Logo -->
    <div class="reset-logo">
      <img src="https://framerusercontent.com/images/AhyGPdkv1Kr9JeLtiQvJBU0uJE.png?scale-down-to=1024&width=2088&height=518" alt="StuchAI Logo" class="logo-image">
    </div>
    
    <!-- Title -->
    <h2 class="reset-title" id="pageTitle">Reset Password</h2>
    
    <!-- Step Indicator -->
    <div class="step-indicator" id="stepIndicator">Step 1 of 2</div>
    
    <!-- Success/Error Message -->
    <div class="reset-message" id="resetMessage"></div>
    
    <!-- Step 1: Request Reset Form -->
    <form id="requestResetForm" onsubmit="handleRequestReset(event)">
      <div class="form-group">
        <label for="emailInput">Email Address</label>
        <input 
          type="email" 
          id="emailInput" 
          class="form-input" 
          required 
          autocomplete="email"
          placeholder="Enter your email address"
        />
      </div>
      
      <button type="submit" class="btn-primary" id="requestBtn">
        <span class="btn-text">Send Reset Link</span>
        <div class="spinner"></div>
      </button>
    </form>
    
    <!-- Step 2: Reset Password Form (hidden initially) -->
    <form id="resetPasswordForm" onsubmit="handleResetPassword(event)" style="display: none;">
      <div class="form-group">
        <label for="passwordInput">New Password</label>
        <input 
          type="password" 
          id="passwordInput" 
          class="form-input" 
          required 
          autocomplete="new-password"
          placeholder="Enter your new password"
          minlength="8"
        />
        <small style="display: block; margin-top: var(--spacing-2); font-size: var(--font-footnote); color: var(--color-label-tertiary);">
          Must be at least 8 characters long
        </small>
      </div>
      
      <div class="form-group">
        <label for="confirmPasswordInput">Confirm New Password</label>
        <input 
          type="password" 
          id="confirmPasswordInput" 
          class="form-input" 
          required 
          autocomplete="new-password"
          placeholder="Confirm your new password"
          minlength="8"
        />
      </div>
      
      <button type="submit" class="btn-primary" id="resetBtn">
        <span class="btn-text">Reset Password</span>
        <div class="spinner"></div>
      </button>
    </form>
    
    <div class="reset-back">
      <p>Remember your password? <a href="/login">Sign in</a></p>
    </div>
  </div>

  <script>
    // Check if token is in URL (Step 2)
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (token) {
      // Show reset password form
      document.getElementById('requestResetForm').style.display = 'none';
      document.getElementById('resetPasswordForm').style.display = 'block';
      document.getElementById('pageTitle').textContent = 'Set New Password';
      document.getElementById('stepIndicator').textContent = 'Step 2 of 2';
      document.getElementById('resetPasswordForm').dataset.token = token;
    }

    async function handleRequestReset(event) {
      event.preventDefault();
      
      const email = document.getElementById('emailInput').value;
      const requestBtn = document.getElementById('requestBtn');
      const messageDiv = document.getElementById('resetMessage');
      
      // Show loading state
      requestBtn.disabled = true;
      requestBtn.classList.add('loading');
      messageDiv.classList.remove('show');
      
      try {
        const response = await fetch('/api/auth/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email }),
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to send reset email');
        }
        
        // Show success message
        messageDiv.className = 'reset-message success show';
        messageDiv.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          <span>If an account with that email exists, a password reset link has been sent. Please check your email.</span>
        `;
        
        // Clear form
        document.getElementById('emailInput').value = '';
      } catch (error) {
        messageDiv.className = 'reset-message error show';
        messageDiv.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          <span>${error.message || 'Failed to send reset email. Please try again.'}</span>
        `;
      } finally {
        requestBtn.disabled = false;
        requestBtn.classList.remove('loading');
      }
    }

    async function handleResetPassword(event) {
      event.preventDefault();
      
      const password = document.getElementById('passwordInput').value;
      const confirmPassword = document.getElementById('confirmPasswordInput').value;
      const resetBtn = document.getElementById('resetBtn');
      const messageDiv = document.getElementById('resetMessage');
      const token = document.getElementById('resetPasswordForm').dataset.token;
      
      // Validate passwords match
      if (password !== confirmPassword) {
        messageDiv.className = 'reset-message error show';
        messageDiv.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          <span>Passwords do not match. Please try again.</span>
        `;
        return;
      }
      
      // Show loading state
      resetBtn.disabled = true;
      resetBtn.classList.add('loading');
      messageDiv.classList.remove('show');
      
      try {
        const response = await fetch('/api/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, password }),
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to reset password');
        }
        
        // Show success message
        messageDiv.className = 'reset-message success show';
        messageDiv.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          <span>Password reset successfully! Redirecting to login...</span>
        `;
        
        // Redirect to login after 2 seconds
        setTimeout(() => {
          window.location.href = '/login';
        }, 2000);
      } catch (error) {
        messageDiv.className = 'reset-message error show';
        messageDiv.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          <span>${error.message || 'Failed to reset password. The link may have expired. Please request a new one.'}</span>
        `;
      } finally {
        resetBtn.disabled = false;
        resetBtn.classList.remove('loading');
      }
    }
  </script>
</body>
</html>
